<?php
// app/Http/Controllers/SearchReindexController.php

namespace App\Http\Controllers;

use App\Http\Requests\ReindexRequest;
use App\Jobs\ReindexEntityJob;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Str;

class SearchReindexController extends Controller
{
    /**
     * Returns the list of indexable entities with the record count.
     */
    public function index(): JsonResponse
    {
        $entities = collect(ReindexRequest::$indexableEntities)
            ->map(fn(string $modelClass, string $slug) => [
                'slug'  => $slug,
                'label' => class_basename($modelClass),
                'count' => $modelClass::count(),
            ])
            ->values();

        return response()->json($entities);
    }

    /**
     * Starts the asynchronous reindexing of an entity.
     */
    public function reindex(ReindexRequest $request): JsonResponse
    {
        $jobId = (string) Str::uuid();

        try {// Attempt to create the index before dispatching the job. If it already exists, we'll ignore the error and let the job handle it.
            $modelClass = $request->modelClass();
            app(\Laravel\Scout\EngineManager::class)->engine()->createIndex(
                (new $modelClass)->searchableAs()
            );
        } catch (\Exception $e) {
            // Index might already exist, ignore errors and proceed with reindexing
        }

        Cache::put("reindex:{$jobId}", [
            'status'   => 'pending',
            'progress' => 0,
            'total'    => 0,
        ], now()->addHours(2));

        ReindexEntityJob::dispatch($jobId, $request->modelClass());

        return response()->json(['job_id' => $jobId], 202);
    }

    /**
     * Flushes the search index for the specified entity.
     */
    public function flush(ReindexRequest $request): JsonResponse
    {
        $modelClass = $request->modelClass();
        $modelClass::removeAllFromSearch();

        return response()->json(['message' => 'Index flushed successfully']);
    }

    /**
     * Deletes the search index for the specified entity.
     */
    public function deleteIndex(ReindexRequest $request): JsonResponse
    {
        $modelClass = $request->modelClass();

        app(\Laravel\Scout\EngineManager::class)->engine()->deleteIndex(
            (new $modelClass)->searchableAs()
        );

        return response()->json(['message' => 'Index deleted successfully']);
    }

    /**
     * Returns the current status of a reindexing job.
     */
    public function status(string $jobId): JsonResponse
    {
        $state = Cache::get("reindex:{$jobId}");

        if (!$state) {
            return response()->json(['message' => 'Job not found or expired'], 404);
        }

        return response()->json($state);
    }
}