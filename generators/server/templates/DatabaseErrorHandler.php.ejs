<?php

namespace App\Exceptions;

use Illuminate\Database\QueryException;
use Illuminate\Http\JsonResponse;

class DatabaseErrorHandler
{
    public static function handle(QueryException $e): JsonResponse
    {
        $sqlState = $e->getCode();

        if (self::isIntegrityError($sqlState)) {
            return response()->json([
                'error' => 'constraint_violation',
                'message' => 'Operation not allowed due to data integrity constraints',
                'details' => $e->getMessage()
            ], 409);
        }

        if (self::isDeadlockError($sqlState)) {
            return response()->json([
                'error' => 'deadlock',
                'message' => 'Database access conflict detected, please retry the operation',
                'details' => $e->getMessage()
            ], 409);
        }

        if (self::isSchemaError($sqlState)) {
            return response()->json([
                'error' => 'schema_error',
                'message' => 'Database configuration error',
                'details' => $e->getMessage()
            ], 500);
        }

        if (self::isConnectionError($sqlState)) {
            return response()->json([
                'error' => 'connection_error',
                'message' => 'Database connection error',
                'details' => $e->getMessage()
            ], 503);
        }

        if (self::isTimeoutError($sqlState)) {
            return response()->json([
                'error' => 'timeout',
                'message' => 'Operation interrupted due to timeout or connection issues',
                'details' => $e->getMessage()
            ], 503);
        }

        if (self::isPermissionError($sqlState)) {
            return response()->json([
                'error' => 'permission_error',
                'message' => 'Database permission error',
                'details' => $e->getMessage()
            ], 403);
        }

        if (self::isResourceError($sqlState)) {
            return response()->json([
                'error' => 'resource_error',
                'message' => 'Database resource error',
                'details' => $e->getMessage()
            ], 503);
        }

        return response()->json([
            'error' => 'database_error',
            'message' => 'An error occurred during the database operation',
            'details' => $e->getMessage()
        ], 500);
    }

    private static function isIntegrityError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '23000', // MySQL, MariaDB, SQLite
            '23503', // PostgreSQL: Foreign key
            '23505', // PostgreSQL: Unique
            '23506', // PostgreSQL: Check
            '23514'  // PostgreSQL: Check
        ]);
    }

    private static function isDeadlockError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '40001', // MySQL, PostgreSQL
            '40P01', // PostgreSQL
            '1205',  // MySQL specific
            'HY000'  // MariaDB/MySQL generic
        ]);
    }

    private static function isSchemaError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '42P01', // PostgreSQL: Undefined table
            '42S02', // MySQL, MariaDB: Table not found
            '42703', // PostgreSQL: Undefined column
            '42S22', // MySQL, MariaDB: Column not found
            '42000'  // SQLite: Generic syntax/schema error
        ]);
    }

    private static function isConnectionError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '08000', // Generic connection error
            '08003', // Connection not open
            '08004', // Connection rejected
            '08006', // Connection failure
            '08S01', // Communication link failure
            'HY000'  // MySQL/MariaDB generic
        ]);
    }

    private static function isTimeoutError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '57014', // PostgreSQL: Query canceled
            '57P01', // PostgreSQL: Admin shutdown
            '57P02', // PostgreSQL: Crash shutdown
            '57P03', // PostgreSQL: Cannot connect now
            'HY000', // MySQL/MariaDB generic
            '2013',  // MySQL: Lost connection
            '2006'   // MySQL: Server gone away
        ]);
    }

    private static function isPermissionError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '42501', // PostgreSQL: Insufficient privilege
            '42000', // MySQL: Syntax error or access violation
            '28000', // PostgreSQL, MySQL: Invalid authorization
            '28P01'  // PostgreSQL: Wrong password
        ]);
    }

    private static function isResourceError(string $sqlState): bool
    {
        return in_array($sqlState, [
            '53000', // PostgreSQL: Insufficient resources
            '53100', // PostgreSQL: Disk full
            '53200', // PostgreSQL: Out of memory
            '53300', // PostgreSQL: Too many connections
            '08004'  // MySQL: Too many connections
        ]);
    }
}
