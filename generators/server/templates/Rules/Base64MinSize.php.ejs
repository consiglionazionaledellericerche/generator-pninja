<?php

namespace App\Rules;

use Illuminate\Contracts\Validation\Rule;

class Base64MinSize implements Rule
{
    private $minSizeBytes;
    private $actualSizeBytes;

    public function __construct($minSizeBytes)
    {
        $this->minSizeBytes = $minSizeBytes;
    }

    public function passes($attribute, $value)
    {
        if (empty($value)) {
            return true;
        }

        $decodedData = base64_decode($value, true);

        if ($decodedData === false) {
            return false;
        }

        $this->actualSizeBytes = strlen($decodedData);

        return $this->actualSizeBytes >= $this->minSizeBytes;
    }

    public function message()
    {
        $actualFormatted = $this->formatBytes($this->actualSizeBytes);
        $minFormatted = $this->formatBytes($this->minSizeBytes);

        return "The :attribute field file is too small: {$this->actualSizeBytes} bytes ({$actualFormatted}). " .
               "Minimum allowed size is {$this->minSizeBytes} bytes ({$minFormatted}).";
    }

    private function formatBytes($bytes)
    {
        if ($bytes < 1000) {
            return $bytes . ' bytes';
        } elseif ($bytes < 1000000) {
            return round($bytes / 1000, 1) . ' kB';
        } elseif ($bytes < 1000000000) {
            return round($bytes / 1000000, 1) . ' MB';
        } else {
            return round($bytes / 1000000000, 2) . ' GB';
        }
    }
}