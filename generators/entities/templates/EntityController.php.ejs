<%
console.log(`${className} relatedEntitiesForFilters`, JSON.stringify(relatedEntitiesForFilters, null, 2))
-%>
<?php
namespace App\Http\Controllers;

use App\Models\<%- className %>;
<%  if (relatedEntitiesForFilters && relatedEntitiesForFilters.length) {-%>
<%      relatedEntitiesForFilters.map(({name}) => {-%>
use App\Models\<%- name %>;
<%      })-%>
<%  }-%> 
use App\Traits\HandlesApiErrors;
use Illuminate\Http\Request;
use Illuminate\Database\QueryException;
use Illuminate\Database\Eloquent\ModelNotFoundException;

class <%- className %>Controller extends Controller
{
    use HandlesApiErrors;

    public function index(Request $request)
    {
        try {
            $query = <%- className %>::query();
<%  if (relatedEntitiesForFilters && relatedEntitiesForFilters.length) {-%>
<%      relatedEntitiesForFilters.map(({name, injectedField}) =>{-%>
            if ($request->has('available_for_<%-to.snake(name)%>')) {
                $<%-to.camel(name)%>Id = $request->query('available_for_<%-to.snake(name)%>');
                $associatedIds = <%-name%>::whereNotNull('<%-to.snake(injectedField)%>_id')
                    ->when($<%-to.camel(name)%>Id, function($query) use ($<%-to.camel(name)%>Id) {
                        return $query->where('id', '!=', $<%-to.camel(name)%>Id);
                    })
                    ->pluck('<%-to.snake(injectedField)%>_id');
                $query->whereNotIn('id', $associatedIds);
            }
<%      })-%>
<%  }-%> 
<%          if (withs) { -%>
            $result = $query->with(<%- withs %>)->get();
<%          } else { -%>
            $result = $query->get();
<%          } -%>
            return response()->json($result);
        } catch (\Exception $e) {
            return $this->handleIndexError($e);
        }
    }

    public function show($id)
    {
        try {
<%          if (withs) { -%>
            return response()->json(<%- className %>::with(<%- withs %>)->findOrFail($id));
<%          } else { -%>
            return response()->json(<%- className %>::findOrFail($id));
<%          } -%>
        } catch (\Exception $e) {
            return $this->handleShowError($e);
        }
    }

    public function store(Request $request)
    {
        try {
            $<%- entityName %> = <%- className %>::create($request->all());
<%          if (createRelated) { -%>
<%- createRelated.split("\n").filter(line => !line.endsWith("// only-update")).join("\n") %>
<%          } -%>
<%          if (withs) { -%>
            $<%- entityName %> = <%- className %>::with(<%- withs %>)->findOrFail($<%- entityName %>->id);
<%          } -%>
            return response()->json($<%- entityName %>, 201);
        } catch (\Exception $e) {
            return $this->handleCreateError($e);
        }
    }
    public function update($id, Request $request)
    {
        try {
<%          if (withs) { -%>
            $<%- entityName %> = <%- className %>::with(<%- withs %>)->findOrFail($id);
<%          } else { -%>
            $<%- entityName %> = <%- className %>::findOrFail($id);
<%          } -%>
            $<%- entityName %>->update($request->all());
<%          if (createRelated) { -%>
<%- createRelated.split("\n").map(line => line.replace(/ \/\/ only-update$/,'')).join("\n") %>
<%          } -%>
            return response()->json($<%- entityName %>, 200);
        } catch (\Exception $e) {
            return $this->handleUpdateError($e);
        }
    }

    public function destroy($id)
    {
        try {
            <%- className %>::findOrFail($id)->delete();
            return response(null, 200);
        } catch (\Exception $e) {
            return $this->handleDeleteError($e);
        }
    }
}