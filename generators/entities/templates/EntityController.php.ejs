<?php
<%
function isEmpty(obj) {
  for (let key in obj) {
    return false;
  }
  return true;
}
-%>
namespace App\Http\Controllers;

use App\Models\<%- className %>;
<%  if (relatedEntitiesForFilters && relatedEntitiesForFilters.length) {-%>
<%      relatedEntitiesForFilters.map(({name}) => {-%>
use App\Models\<%- name %>;
<%      })-%>
<%  }-%>
use App\Traits\HandlesApiErrors;
// use App\Traits\HandlesUserRoles;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Validation\Rule;

class <%- className %>Controller extends Controller
{
    use HandlesApiErrors;
    // use HandlesUserRoles;

    // private $viewerRole = 'viewer';

    public function index(Request $request)
    {
        try {
            // if (!$this->userHasRole($this->viewerRole)) return response()->json(['error' => 'Forbidden'], 403);
            $perPage = min($request->get('per_page', 10), 100);
            $sortBy = $request->get('sort_by', 'id');
            $sortDirection = $request->get('sort_direction', 'asc');

            if ($request->has('ids') && !empty($request->get('ids'))) {
                $ids = explode(',', $request->get('ids'));
                $result = <%- className %>::whereIn('id', $ids)
<%  if (withs) { -%>
                    ->with(<%- withs %>)
<%  } -%>
                    ->orderBy($sortBy, $sortDirection)
                    ->paginate($perPage);
                return response()->json($result);
            }

<%  if (relatedEntitiesForFilters && relatedEntitiesForFilters.length) {-%>
            $excludeIds = [];
<%      relatedEntitiesForFilters.map(({name, injectedField}) =>{-%>
            if ($request->has('available_for_<%-to.snake(name)%>')) {
                $<%-to.camel(name)%>Id = $request->query('available_for_<%-to.snake(name)%>');
                $excludeIds = <%-name%>::whereNotNull('<%-to.snake(injectedField)%>_id')
                    ->when($<%-to.camel(name)%>Id, function($query) use ($<%-to.camel(name)%>Id) {
                        return $query->where('id', '!=', $<%-to.camel(name)%>Id);
                    })
                    ->pluck('<%-to.snake(injectedField)%>_id');
            }
<%      })-%>
<%  }-%>
            if ($request->has('search') && !empty($request->get('search'))) {
                $result = <%- className %>::search($request->get('search'))
<%  if (relatedEntitiesForFilters && relatedEntitiesForFilters.length) {-%>
                    ->query(function ($builder) use ($excludeIds) {
                        $builder->whereNotIn('id', $excludeIds)<% if (withs) { %>->with(<%- withs %>)<% } %>;
                    })
<%  } else if (withs) { -%>
                    ->query(function ($builder) {
                        $builder->with(<%- withs %>);
                    })
<%  }-%>
                    ->paginate($perPage);
            } else {
                $result = <%- className %><% if (withs) { %>::with(<%- withs %>)<% } %>
<%  if (relatedEntitiesForFilters && relatedEntitiesForFilters.length) {-%>
                    ->whereNotIn('id', $excludeIds)
<%  }-%>
                    ->orderBy($sortBy, $sortDirection)
                    ->paginate($perPage);
            }

<%          if(isSqlite && booleanFields.length >= 0) {-%>
            $result = $result->map(function($entity) {
<%              booleanFields.forEach(field => {-%>
                $entity['<%-field%>'] = boolval($entity['<%-field%>']);
<%              }); -%>
                return $entity;
            });
<%          } -%>
            return response()->json($result);
        } catch (\Exception $e) {
            return $this->handleIndexError($e);
        }
    }

    public function show($id)
    {
        try {
<%          if (withs) { -%>
            $<%- entityName %> = <%- className %>::with(<%- withs %>)->findOrFail($id);
<%          } else { -%>
            $<%- entityName %> = <%- className %>::findOrFail($id);
<%          } -%>
<%          if(isSqlite && booleanFields.length >= 0) {-%>
<%              booleanFields.forEach(field => {-%>
            $<%- entityName %>['<%-field%>'] = boolval($<%- entityName %>['<%-field%>']);
<%              }); -%>
<%          } -%>
            return response()->json($<%- entityName %>);
        } catch (\Exception $e) {
            return $this->handleShowError($e);
        }
    }

    public function store(Request $request)
    {
        try {
<%  if(isEmpty(validationsStore)) {-%>
            $data = $request->all();
<%  } else {-%>
            $validated = $request->validate([
<%      for (field in validationsStore) {-%>
<%          if(!fileFields.includes(field)) { -%>
                '<%- field %>' => [
<%          validationsStore[field].forEach(validation => {-%>
                    <%- validation %>,
<%          })-%>
                ],
<%          } else {-%>
                '<%- field %>.data' => [
<%          validationsStore[field].forEach(validation => {-%>
                    <%- validation %>,
<%          })-%>
                ],
                '<%- field %>.mimeType' => [
                    '<%- validationsStore[field].includes("'required'") ? 'required' : 'nullable' %>',
<%                  if (imageFields.includes(field)) { -%>
                    'image_mimetype',
<%                  } -%>
                ],
                '<%- field %>.originalName' => [
                    '<%- validationsStore[field].includes("'required'") ? 'required' : 'nullable' %>',
                ],
                '<%- field %>.delete' => [
                    'boolean',
                ],
<%          } -%>
<%      }-%>
            ]);
            $data = $validated;
<%  }-%>
<%          fileFields.forEach((field) => {-%>
            if(isset($data['<%-to.snake(field)%>']['data'])) {
                $fileData = base64_decode($data['<%-to.snake(field)%>']['data']);
                $mimeType = $data['<%-to.snake(field)%>']['mimeType'];
                $originalName = $data['<%-to.snake(field)%>']['originalName'];
                $filename = uniqid() . '-' . $originalName;
                $path = 'uploads/' . date('Y/m/d') . '/' . $filename;
                $stored = Storage::disk('private')->put($path, $fileData);
                if($stored) {
                    $data['<%-to.snake(field)%>_path'] = $path;
                    $data['<%-to.snake(field)%>_type'] = $mimeType;
                    $data['<%-to.snake(field)%>_name'] = $originalName;
                }
            }
<%    });-%>

            $<%- entityName %> = <%- className %>::create($data);
<%          if (createRelated) { -%>
<%- createRelated.split("\n").filter(line => !line.endsWith("// only-update")).join("\n") %>
<%          } -%>
<%          if (withs) { -%>
            $<%- entityName %> = <%- className %>::with(<%- withs %>)->findOrFail($<%- entityName %>->id);
<%          } -%>
            return response()->json($<%- entityName %>, 201);
        } catch (\Exception $e) {
            return $this->handleCreateError($e);
        }
    }
    public function update($id, Request $request)
    {
        try {
<%  if (withs) { -%>
            $<%- entityName %> = <%- className %>::with(<%- withs %>)->findOrFail($id);
<%  } else { -%>
            $<%- entityName %> = <%- className %>::findOrFail($id);
<%  } -%>

<%  if(isEmpty(validationsUpdate)) {-%>
            $data = $request->all();
<%  } else {-%>
            $validated = $request->validate([
<%      for (field in validationsUpdate) {-%>
<%          if(!fileFields.includes(field)) { -%>
                '<%- field %>' => [
<%          validationsUpdate[field].forEach(validation => {-%>
                    <%- validation %>,
<%          })-%>
                ],
<%          } else {-%>
                '<%- field %>.data' => [
<%          validationsStore[field].forEach(validation => {-%>
<%              if (validation === `'required'`) { -%>
                    <%- validationsStore[field].includes("'required'") ? `$${entityName}['${field}_path'] ? 'nullable' : 'required'` : `'nullable'` %>,
<%              } else {-%>
                    <%- validation %>,
<%              } -%>
<%          })-%>
                ],
                '<%- field %>.mimeType' => [
                    <%- validationsStore[field].includes("'required'") ? `$${entityName}['${field}_type'] ? 'nullable' : 'required'` : `'nullable'` %>,
<%                  if (imageFields.includes(field)) { -%>
                    'image_mimetype',
<%                  } -%>
                ],
                '<%- field %>.originalName' => [
                    <%- validationsStore[field].includes("'required'") ? `$${entityName}['${field}_name'] ? 'nullable' : 'required'` : `'nullable'` %>,
                ],
                '<%- field %>.delete' => [
                    'boolean',
                ],
<%          } -%>
<%      }-%>
            ]);
            $data = $validated;
<%  }-%>
<%  if(!isEmpty(fileFields)) {-%>

            $filesToDeletePaths = [];

<%      fileFields.forEach((field) => {-%>
            if(isset($data['<%-to.snake(field)%>']['data'])) {
                if ($<%- entityName %>-><%-to.snake(field)%>_path) {
                    Storage::disk('private')->delete($<%- entityName %>-><%-to.snake(field)%>_path);
                }
                $fileData = base64_decode($data['<%-to.snake(field)%>']['data']);
                $mimeType = $data['<%-to.snake(field)%>']['mimeType'];
                $originalName = $data['<%-to.snake(field)%>']['originalName'];
                $filename = uniqid() . '-' . $originalName;
                $path = 'uploads/' . date('Y/m/d') . '/' . $filename;
                $stored = Storage::disk('private')->put($path, $fileData);
                if($stored) {
                    $data['<%-to.snake(field)%>_path'] = $path;
                    $data['<%-to.snake(field)%>_type'] = $mimeType;
                    $data['<%-to.snake(field)%>_name'] = $originalName;
                }
            }
            if (isset($data['<%-to.snake(field)%>']['delete']) && $data['<%-to.snake(field)%>']['delete'] && $<%- entityName %>-><%-to.snake(field)%>_path) {
                $filesToDeletePaths[] = $<%- entityName %>-><%-to.snake(field)%>_path;
                $<%- entityName %>-><%-to.snake(field)%>_path = null;
                $<%- entityName %>-><%-to.snake(field)%>_type = null;
                $<%- entityName %>-><%-to.snake(field)%>_name = null;
            }

<%      });-%>
<%  }-%>
            $<%- entityName %>->update($data);
<%  if(!isEmpty(fileFields)) {-%>

            foreach ($filesToDeletePaths as $filePath) {
                if ($filePath && Storage::disk('private')->exists($filePath)) {
                    Storage::disk('private')->delete($filePath);
                }
            }

<%  }-%>
<%          if (createRelated) { -%>
<%- createRelated.split("\n").map(line => line.replace(/ \/\/ only-update$/,'')).join("\n") %>
<%          } -%>
            return response()->json($<%- entityName %>, 200);
        } catch (\Exception $e) {
            return $this->handleUpdateError($e);
        }
    }

    public function destroy($id)
    {
        try {
            $<%- entityName %> = <%- className %>::findOrFail($id);
            $<%- entityName %>->delete();
<%  fileFields.forEach((field) => {-%>
            if ($<%- entityName %>-><%-to.snake(field)%>_path) {
                Storage::disk('private')->delete($<%- entityName %>-><%-to.snake(field)%>_path);
            }
<%  });-%>
            return response(null, 200);
        } catch (\Exception $e) {
            return $this->handleDeleteError($e);
        }
    }
}