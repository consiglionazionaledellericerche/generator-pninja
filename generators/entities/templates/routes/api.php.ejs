<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\FileController;
use App\Http\Controllers\SessionAuthController;
use App\Http\Controllers\StructureController;
use App\Http\Controllers\PilotController;
use App\Http\Controllers\CertificationTypeController;
use App\Http\Controllers\CertificationController;
use App\Http\Controllers\AuthorizationController;
use App\Http\Controllers\UasController;
use App\Http\Controllers\PayloadController;
use App\Http\Controllers\MissionController;
use App\Http\Controllers\DataManagerController;
use App\Http\Controllers\AcRuleController;
use App\Http\Controllers\AuditController;
use App\Http\Controllers\UserRoleController;

Route::get('/health', function () {
    return response()->json([
        'status' => 'ok',
        'timestamp' => now()->toIso8601String()
    ]);
});

Route::prefix('auth')->group(function () {
    Route::get('/check-session', [SessionAuthController::class, 'checkSession']);
    Route::post('/initiate-login', [SessionAuthController::class, 'initiateLogin']);
    Route::post('/logout', [SessionAuthController::class, 'logout']);
    Route::get('/csrf-token', [SessionAuthController::class, 'getCsrfToken']);
    Route::get('/callback', [SessionAuthController::class, 'handleCallback']);
});

Route::middleware(['session.auth'])->prefix('user')->group(function () {
    Route::get('/roles', [UserRoleController::class, 'getRoles']);
    Route::post('/has-role', [UserRoleController::class, 'hasRole']);
    Route::post('/has-any-role', [UserRoleController::class, 'hasAnyRole']);
    Route::post('/has-all-roles', [UserRoleController::class, 'hasAllRoles']);
    Route::post('/can', [UserRoleController::class, 'canPerformAction']);
});

Route::get('/files/public/{path}', [FileController::class, 'serveFile'])
    ->where('path', '.*')
    ->defaults('disk', 'public')
    ->name('files.serve.public');

Route::middleware(['session.auth', 'access.control'])->group(function () {
    Route::apiResource('structures', StructureController::class);
    Route::apiResource('pilots', PilotController::class);
    Route::get('pilots/{id}/{field}/{filename?}', [PilotController::class, 'serveBlob']);
    Route::apiResource('certification-types', CertificationTypeController::class);
    Route::apiResource('certifications', CertificationController::class);
    Route::get('certifications/{id}/{field}/{filename?}', [CertificationController::class, 'serveBlob']);
    Route::apiResource('authorizations', AuthorizationController::class);
    Route::apiResource('uas', UasController::class);
    Route::get('uas/{id}/{field}/{filename?}', [UasController::class, 'serveBlob']);
    Route::apiResource('payloads', PayloadController::class);
    Route::apiResource('missions', MissionController::class);
    Route::apiResource('data-managers', DataManagerController::class);
    Route::apiResource('ac-rules', AcRuleController::class);

    Route::prefix('audits')->group(function () {
        Route::get('/', [AuditController::class, 'index']);
        Route::get('/statistics', [AuditController::class, 'statistics']);
        Route::get('/timeline', [AuditController::class, 'timeline']);
        Route::get('/models', [AuditController::class, 'models']);
        Route::get('/users', [AuditController::class, 'users']);
        Route::get('/entity/{type}/{id}', [AuditController::class, 'entity']);
        Route::get('/user/{userId}/profile', [AuditController::class, 'userProfile']);
        Route::get('/user/{userId}/timeline', [AuditController::class, 'userTimeline']);
        Route::get('/user/{userId}/hourly-pattern', [AuditController::class, 'userHourlyPattern']);
        Route::get('/user/{userId}/weekly-pattern', [AuditController::class, 'userWeeklyPattern']);
        Route::get('/user/{userId}/sessions', [AuditController::class, 'userSessions']);
        Route::get('/export', [AuditController::class, 'export']);
        Route::get('/{id}/compare', [AuditController::class, 'compare']);
        Route::get('/{id}', [AuditController::class, 'show']);
    });

    Route::get('/files/private/{path}', [FileController::class, 'serveFile'])
        ->where('path', '.*')
        ->defaults('disk', 'private')
        ->name('files.serve.private');
});
