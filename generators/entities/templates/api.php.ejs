<?php

use Lauthz\Facades\Enforcer;
use Illuminate\Support\Facades\Route;
use Illuminate\Http\Request;
use App\Http\Controllers\FileController;
use App\Http\Controllers\SessionAuthController;
<% eRoutes.forEach(({className}) => {-%>
use App\Http\Controllers\<%- className %>Controller;
<% }); -%>

Route::get('/health', function () {
    return response()->json([
        'status' => 'ok',
        'timestamp' => now()->toIso8601String()
    ]);
});

Route::prefix('auth')->group(function () {
    Route::get('/check-session', [SessionAuthController::class, 'checkSession']);
    Route::post('/initiate-login', [SessionAuthController::class, 'initiateLogin']);
    Route::post('/logout', [SessionAuthController::class, 'logout']);
    Route::get('/csrf-token', [SessionAuthController::class, 'getCsrfToken']);
    Route::get('/callback', [SessionAuthController::class, 'handleCallback']);
});

Route::middleware(['session.auth'])->get('/user/permissions', function (Request $request) {
    $username = auth()->user()->username ?? '';
    return response()->json([
        'roles' => Enforcer::getRolesForUser($username),
    ]);
});

Route::middleware(['session.auth'])->post('/user/can', function (Request $request) {
    $resource = $request->resource ?? null;
    $action = $request->action ?? null;
    $username = auth()->user()->username ?? '';
    $allowed = Enforcer::enforce($username, $resource, $action);

    return response()->json(['allowed' => $allowed]);
});

Route::get('/files/public/{path}', [FileController::class, 'serveFile'])
    ->where('path', '.*')
    ->defaults('disk', 'public')
    ->name('files.serve.public');

Route::middleware(['session.auth', 'access.control'])->group(function () {
<% eRoutes.forEach(({className, rootPath, hasBlob}) => {-%>
    Route::apiResource('<%- rootPath %>', <%- className %>Controller::class);
<%  if (hasBlob) { -%>
    Route::get('<%- rootPath %>/{id}/{field}/{filename?}', [<%- className %>Controller::class, 'serveBlob']);
<%  }; -%>
<% }); -%>

    Route::get('/files/private/{path}', [FileController::class, 'serveFile'])
        ->where('path', '.*')
        ->defaults('disk', 'private')
        ->name('files.serve.private');
});
