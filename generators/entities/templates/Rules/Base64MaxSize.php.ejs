<?php

namespace App\Rules;

use Illuminate\Contracts\Validation\Rule;

class Base64MaxSize implements Rule
{
    private $maxSizeBytes;
    private $actualSizeBytes;

    public function __construct($maxSizeBytes)
    {
        $this->maxSizeBytes = $maxSizeBytes;
    }

    public function passes($attribute, $value)
    {
        if (empty($value)) {
            return true;
        }

        $decodedData = base64_decode($value, true);

        if ($decodedData === false) {
            return false;
        }

        $this->actualSizeBytes = strlen($decodedData);

        return $this->actualSizeBytes <= $this->maxSizeBytes;
    }

    public function message()
    {
        $actualFormatted = $this->formatBytes($this->actualSizeBytes);
        $maxFormatted = $this->formatBytes($this->maxSizeBytes);

        return "File is too large: {$this->actualSizeBytes} bytes ({$actualFormatted}). " .
               "Maximum allowed size is {$this->maxSizeBytes} bytes ({$maxFormatted}).";
    }

    private function formatBytes($bytes)
    {
        if ($bytes < 1000) {
            return $bytes . ' bytes';
        } elseif ($bytes < 1000000) {
            return round($bytes / 1000, 1) . ' kB';
        } elseif ($bytes < 1000000000) {
            return round($bytes / 1000000, 1) . ' MB';
        } else {
            return round($bytes / 1000000000, 2) . ' GB';
        }
    }
}