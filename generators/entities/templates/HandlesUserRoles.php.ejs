<?php

namespace App\Traits;

use Illuminate\Support\Facades\Session;
use App\Models\AclRule;
use Lauthz\Facades\Enforcer;

trait HandlesUserRoles
{
    /**
     * Retrieve the roles associated with the currently authenticated user.
     *
     * This method fetches the authenticated user's information from the session.
     * If the user is not authenticated, it returns an empty array. Otherwise, it
     * queries the database for the user's roles and returns them as an array of
     * role names.
     *
     * @return array The list of role names assigned to the authenticated user.
     */
    protected function getUserRoles(): array
    {
        $userInfo = Session::get('authenticated_user');
        if (!$userInfo) return [];
        $roles = AclRule::where('ptype', 'g')
        ->where('v0', $userInfo['preferred_username'])
        ->pluck('v1');
        return $roles->toArray() ?? [];
    }

    /**
     * Checks if the authenticated user has the specified role.
     *
     * @param string $role The role to check.
     * @return bool True if the user has the role, false otherwise.
     * @throws \Exception If the Client ID is not configured.
     */
    protected function userHasRole($role)
    {
        $roles = $this->getUserRoles();
        if (empty($roles)) return false;
        return in_array($role, $roles);
    }

    /**
     * Checks if the user has any of the specified roles.
     *
     * @param array $roles Array of roles to check.
     * @return bool True if the user has at least one of the roles.
     */
    protected function userHasAnyRole(array $roles)
    {
        foreach ($roles as $role) {
            if ($this->userHasRole($role)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Checks if the user has all the specified roles.
     *
     * @param array $roles Array of roles to check.
     * @return bool True if the user has all the roles.
     */
    protected function userHasAllRoles(array $roles)
    {
        foreach ($roles as $role) {
            if (!$this->userHasRole($role)) {
                return false;
            }
        }
        return true;
    }


    /**
     * Checks if the user has permission to perform a specific action on a given resource.
     *
     * This method retrieves the authenticated user's roles from the session and verifies
     * if any of the roles have the required permission for the specified resource and action.
     * It uses the Casbin Enforcer for permission enforcement.
     *
     * @param string $resource The resource to check permissions for.
     * @param string $action The action to check permissions for.
     * @return bool Returns true if the user has the required permission, false otherwise.
     */

    protected function userHasPermission(string $resource, string $action): bool
    {
        $result = Enforcer::enforce(auth()->user()->username, $resource, $action);
        return $result;
    }
}