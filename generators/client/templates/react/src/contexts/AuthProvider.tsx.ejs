import React, { useEffect, useState, ReactNode } from 'react';
import { User, AuthContextType } from '../types/auth';
import { AuthContext } from './AuthContext';

interface AuthState {
  isAuthenticated: boolean;
  user: User | null;
  loading: boolean;
  error: string | null;
}

interface AuthProviderProps {
  children: ReactNode;
}

export const AuthProvider: React.FC<AuthProviderProps> = ({ children }) => {
  const [authState, setAuthState] = useState<AuthState>({
    isAuthenticated: false,
    user: null,
    loading: true,
    error: null,
  });

  useEffect(() => {
    const checkSession = async () => {
      try {
        console.log('üîç Checking server session...');

        // Check for auth_success parameter in URL
        const urlParams = new URLSearchParams(window.location.search);
        const authSuccess = urlParams.get('auth_success');

        if (authSuccess === 'true') {
          console.log('‚úÖ Auth success detected in URL');
          // Remove the parameter without refreshing the page
          const newUrl =
            window.location.pathname +
            (window.location.search
              ? window.location.search.replace(/auth_success=true&?/, '')
              : '') +
            window.location.hash;
          window.history.replaceState({}, document.title, newUrl);
        }

        // Check if there's an active session on the server
        const response = await fetch('/api/auth/check-session', {
          credentials: 'include', // IMPORTANTE: include cookies di sessione
        });

        if (response.ok) {
          const data = await response.json();

          if (data.isAuthenticated) {
            console.log('‚úÖ Active session found:', data.user.name);

            setAuthState({
              isAuthenticated: true,
              user: data.user,
              loading: false,
              error: null,
            });

            return;
          }
        }

        console.log('‚ùå No active session found');

        // No valid session found
        setAuthState({
          isAuthenticated: false,
          user: null,
          loading: false,
          error: null,
        });
      } catch (error) {
        console.error('‚ùå Session check error:', error);
        setAuthState({
          isAuthenticated: false,
          user: null,
          loading: false,
          error: 'Session check error',
        });
      }
    };

    checkSession();
  }, []);

  // Login function (molto pi√π semplice!)
  const login = async (): Promise<{ success: boolean; error?: string }> => {
    try {
      console.log('üöÄ Starting login process...');

      // Save current URL for redirect after login
      const currentUrl = window.location.href;

      // Request authorization URL from backend
      const response = await fetch('/api/auth/initiate-login', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          redirect_url: currentUrl,
        }),
        credentials: 'include',
      });

      if (!response.ok) {
        throw new Error('Login initialization error');
      }

      const data = await response.json();

      console.log('üîó Redirecting to Keycloak...');

      // Redirect user to Keycloak authorization URL
      window.location.href = data.authUrl;

      return { success: true };
    } catch (error) {
      console.error('‚ùå Login start error:', error);

      setAuthState((prev) => ({
        ...prev,
        loading: false,
        error: 'Login start error',
      }));

      return {
        success: false,
        error: 'Login start error',
      };
    }
  };

  // Logout function (anche questo pi√π semplice!)
  const logout = async (): Promise<void> => {
    try {
      console.log('üëã Logging out...');

      const response = await fetch('/api/auth/logout', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRF-TOKEN': await getCsrfToken(),
        },
        credentials: 'include',
      });

      // Update state immediately
      setAuthState({
        isAuthenticated: false,
        user: null,
        loading: false,
        error: null,
      });

      if (response.ok) {
        const data = await response.json();

        // If we have a logout URL for SSO, redirect
        if (data.logoutUrl) {
          console.log('üîó Redirecting to Keycloak logout...');
          window.location.href = data.logoutUrl;
        }
      }
    } catch (error) {
      console.error('‚ùå Logout error:', error);

      // Clear state even on error
      setAuthState({
        isAuthenticated: false,
        user: null,
        loading: false,
        error: null,
      });
    }
  };

  // Helper function to get CSRF token
  const getCsrfToken = async (): Promise<string> => {
    try {
      const response = await fetch('/api/auth/csrf-token', {
        credentials: 'include',
      });
      if (response.ok) {
        const data = await response.json();
        return data.csrf_token;
      }
    } catch (error) {
      console.warn('Failed to get CSRF token:', error);
    }
    return '';
  };

  // Combine all auth state and functions
  const contextValue: AuthContextType = {
    ...authState,
    tokens: null, // Non abbiamo pi√π token!
    login,
    logout,
    refreshTokens: async () => {
      // Non necessario con le sessioni!
      throw new Error('Token refresh not needed with session auth');
    },
  };

  return <AuthContext.Provider value={contextValue}>{children}</AuthContext.Provider>;
};
