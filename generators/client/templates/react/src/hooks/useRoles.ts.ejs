import { useCallback } from 'react';

const KEYCLOAK_CLIENT_ID = import.meta.env.VITE_KEYCLOAK_CLIENT_ID || '';

const getRolesFromSession = (): string[] => {
  console.info('Retrieving roles from session');
  try {
    const xhr = new XMLHttpRequest();
    xhr.open('GET', '/api/auth/check-session', false);
    xhr.withCredentials = true;
    xhr.send();

    if (xhr.status === 200) {
      const response = JSON.parse(xhr.responseText);
      return response?.user?.resource_access[KEYCLOAK_CLIENT_ID]?.roles || [];
    }

    return [];
  } catch (error) {
    console.error('Error getting roles from session:', error);
    return [];
  }
};

export const useRoles = () => {
  const getRoles = useCallback((): string[] => {
    const userRoles = getRolesFromSession();
    if (!userRoles) return [];
    return userRoles;
  }, []);

  const hasAnyRole = useCallback(
    (testRoles: string[]): boolean => testRoles.some((role) => getRoles().includes(role)),
    [getRoles]
  );

  const hasAllRoles = useCallback(
    (testRoles: string[]): boolean => testRoles.every((role) => getRoles().includes(role)),
    [getRoles]
  );

  return {
    getRoles,
    hasAnyRole,
    hasAllRoles,
  };
};
