import React, { useEffect } from 'react';
import { Outlet, useLocation } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';
import { useRoles } from '../hooks/useRoles';
import Err403 from '../pages/errors/Err403';

interface RoleProtectedRouteProps {
  requiredRoles?: string[];
  requireAll?: boolean; // Se true, l'utente deve avere TUTTI i ruoli specificati
}

// Componente loading spinner
const LoadingSpinner: React.FC = () => (
  <div className="loading-spinner">Caricamento in corso...</div>
);

// Componente accesso negato
const AccessDenied: React.FC = () => <Err403 />;

const RoleProtectedRoute: React.FC<RoleProtectedRouteProps> = ({
  requiredRoles = [],
  requireAll = false,
}) => {
  const { isAuthenticated, loading, login } = useAuth();
  const { hasAllRoles, hasAnyRole } = useRoles();
  const location = useLocation();

  // Avvia il flusso di autenticazione se l'utente non Ã¨ autenticato
  useEffect(() => {
    if (!loading && !isAuthenticated) {
      // Salva l'URL corrente per reindirizzare dopo il login
      // Questa informazione potrebbe essere salvata in localStorage se necessario
      localStorage.setItem('authRedirectUrl', location.pathname);

      // Avvia il processo di login, che reindirizza a Keycloak
      login();
    }
  }, [loading, isAuthenticated, login, location]);

  // Mostra il loader mentre verifichiamo l'autenticazione
  if (loading || !isAuthenticated) {
    return <LoadingSpinner />;
  }

  // Se non ci sono ruoli richiesti, permetti l'accesso
  if (requiredRoles.length === 0) {
    return <Outlet />;
  }

  // Verifica i ruoli richiesti
  const hasRequiredRoles = requireAll
    ? hasAllRoles(requiredRoles) // Deve avere TUTTI i ruoli
    : hasAnyRole(requiredRoles); // Deve avere ALMENO UNO dei ruoli

  // Se l'utente ha i ruoli richiesti, permetti l'accesso
  if (hasRequiredRoles) {
    return <Outlet />;
  }

  // Altrimenti mostra accesso negato
  return <AccessDenied />;
};

export default RoleProtectedRoute;
