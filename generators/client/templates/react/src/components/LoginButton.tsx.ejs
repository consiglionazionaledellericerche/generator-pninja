import { useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useAuthState } from '../contexts/AuthContext';
import { LogIn, Loader } from 'lucide-react';
import { useLocation } from 'react-router-dom';

export function LoginButton() {
  const { login, loading: authLoading } = useAuthState();
  const location = useLocation();
  const { t } = useTranslation();
  const [localError, setLocalError] = useState<string | null>(null);

  const handleLogin = async () => {
    setLocalError(null);

    try {
      localStorage.setItem('authRedirectUrl', location.pathname);
      // Utilizza la funzione login() dall'hook di autenticazione
      // Questa gestirà già lo stato di loading globale
      const result = await login();

      if (!result.success) {
        setLocalError(result.error || 'Errore durante il login');
      }
      // Non serve gestire il redirect qui perché login() lo fa già
    } catch (error) {
      console.error('Errore durante il login:', error);
      setLocalError('Errore imprevisto durante il login');
    }
  };

  return (
    <div>
      {localError && <div className="error-message">{localError}</div>}

      <button
        onClick={handleLogin}
        disabled={authLoading}
        className={`inline-flex items-center gap-1 nav-bar-link ${authLoading ? 'opacity-70 cursor-not-allowed' : ''}`}
      >
        {authLoading ? <Loader size={16} className="animate-spin" /> : <LogIn size={16} />}
        {authLoading ? t('ui.account.loggingIn') : t('ui.account.login')}
      </button>
    </div>
  );
}
