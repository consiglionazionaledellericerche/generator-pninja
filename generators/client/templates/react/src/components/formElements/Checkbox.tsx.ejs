import { RegisterOptions, FieldValues } from 'react-hook-form';
import { useFormContext, useController } from 'react-hook-form';
import { SquareIcon, SquareCheckBigIcon, AsteriskIcon } from 'lucide-react';
import { FormFieldInfoContents } from './index';
import {
  Checkbox as CheckboxAria,
  CheckboxProps as CheckboxPropsAria,
  Text,
} from 'react-aria-components';
import { useId } from 'react-aria';
import { useTranslation } from 'react-i18next';

interface CheckboxProps
  extends Omit<CheckboxPropsAria, 'isInvalid' | 'isSelected' | 'isRequired' | 'children'> {
  fieldName: string;
  label: string;
  validations?: {
    required?: boolean;
  };
}

const Checkbox: React.FC<CheckboxProps> = ({ fieldName, label, validations, ...ariaProps }) => {
  const { t } = useTranslation();
  const descriptionId = useId();
  const errorId = useId();
  const { required } = validations || {};
  const { control, setValue } = useFormContext();
  const rules: RegisterOptions<FieldValues, string> | undefined = {};

  if (required) {
    rules.required = 'errors.validations.required';
  }
  const {
    field,
    fieldState: { error },
  } = useController({
    name: fieldName,
    control,
    rules,
    defaultValue: false,
  });

  return (
    <>
      <div>
        <CheckboxAria
          aria-describedby={error ? errorId : validations ? descriptionId : undefined}
          {...ariaProps}
          {...field}
          isInvalid={!!error}
          isRequired={required}
          isSelected={field.value}
          onChange={() =>
            setValue(fieldName, !field.value, { shouldValidate: true, shouldDirty: true })
          }
          className="group"
        >
          <div className="text-sm font-medium">
            {label}
            {validations?.required && (
              <AsteriskIcon aria-hidden="true" className="inline align-top size-5 sm:size-4" />
            )}
          </div>
          <div
            className={`
        mt-3 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 p-2
        group-focus-within:outline-3
        group-focus-within:outline-offset-3 group-focus-within:outline-blue-600
        group-focus-within:dark:outline-sky-300 rounded-md block
        ${
          error
            ? `
        group-focus-within:ring-0
        group-focus-within:outline-3
        group-focus-within:outline-offset-3
        group-focus-within:outline-red-600!
        group-focus-within:dark:outline-red-500!
        ring-2
        ring-red-600
        dark:ring-red-500`
            : ''
        }
        `}
          >
            {field.value ? (
              <SquareCheckBigIcon
                className="mx-auto h-7 w-7 rounded-md outline-0"
                aria-hidden="true"
              />
            ) : (
              <SquareIcon className="mx-auto h-7 w-7 rounded-md outline-0" aria-hidden="true" />
            )}
          </div>
        </CheckboxAria>
      </div>
      {validations && !error && (
        <p className="text-sm mt-1">
          <Text slot="description" id={descriptionId}>
            <FormFieldInfoContents validations={validations} {...ariaProps} />
          </Text>
        </p>
      )}
      {error && error?.message && (
        <p
          id={errorId}
          className="block mt-1 text-sm bg-slate-50 dark:bg-slate-900 text-red-600 dark:text-red-500"
        >
          {t(error.message)}
        </p>
      )}
    </>
  );
};

export { Checkbox };
