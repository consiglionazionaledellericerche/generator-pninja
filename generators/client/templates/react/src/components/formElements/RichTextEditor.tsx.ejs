import React, { useEffect, useRef } from 'react';

// Dichiarazioni di tipo per Jodit
interface JoditConfig {
  aria: boolean;
  readonly: boolean;
  disabled: boolean;
  tabIndex: number;
  placeholder?: string;
  height?: number;
  buttons?: (string | object)[];
  controls?: {
    paragraph?: {
      list?: Record<string, string>;
    };
  };
  uploader?: {
    insertImageAsBase64URI?: boolean;
  };
}

declare global {
  interface Window {
    Jodit: {
      make: (element: HTMLTextAreaElement, config: JoditConfig) => JoditInstance;
    };
  }
}

interface JoditInstance {
  value: string;
  events: {
    on: (event: string, callback: () => void) => void;
  };
  destruct: () => void;
  observer: {
    clear: () => void;
  };
}

interface RichTextEditorProps {
  placeholder?: string;
  hasErrors?: boolean;
  onChange?(value: string): void;
  initialContent?: string;
}

const RichTextEditor: React.FC<RichTextEditorProps> = ({
  placeholder = '',
  onChange,
  initialContent = '',
  hasErrors = false,
}) => {
  const textareaRef = useRef<HTMLTextAreaElement>(null);
  const editorRef = useRef<JoditInstance | null>(null);

  useEffect(() => {
    let joditInstance: JoditInstance | null = null;

    const initEditor = () => {
      if (!window.Jodit || !textareaRef.current) return;

      const config: JoditConfig = {
        aria: true,
        readonly: false,
        disabled: false,
        tabIndex: 0,
        placeholder,
        height: 400,
        buttons: [
          'undo',
          'redo',
          '|',
          'cut',
          'copy',
          'paste',
          '|',
          'paragraph',
          '|',
          'bold',
          'italic',
          '|',
          'ul',
          'ol',
          '|',
          'left',
          'center',
          'right',
          'justify',
          '|',
          'table',
          'symbols',
          '|',
          'link',
          'image',
          'video',
          '|',
          'source',
        ],
        uploader: {
          insertImageAsBase64URI: true,
        },
      };

      joditInstance = window.Jodit.make(textareaRef.current, config);
      editorRef.current = joditInstance;

      // Set initial content
      joditInstance.value = '';

      // Handle changes
      const handleChange = () => {
        if (onChange) {
          onChange(joditInstance?.value || '');
        }
      };

      joditInstance.events.on('change', handleChange);
    };

    if (window.Jodit) {
      initEditor();
    } else {
      // Load Jodit
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = 'https://cdnjs.cloudflare.com/ajax/libs/jodit/3.24.5/jodit.min.css';
      document.head.appendChild(link);

      const script = document.createElement('script');
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jodit/3.24.5/jodit.min.js';
      script.onload = initEditor;
      document.head.appendChild(script);
    }

    return () => {
      if (joditInstance) {
        joditInstance.destruct();
      }
    };
  }, []);

  useEffect(() => {
    const editor = editorRef.current as unknown as JoditInstance;
    if (editor && initialContent && editor?.value?.trim() === '') {
      editor.value = initialContent;
      editor.observer.clear();
    }
  }, [initialContent]);

  return (
    <>
      <div
        className={`
      ${hasErrors ? 'outline-2 -outline-offset-2 outline-red-500' : 'outline-0'}
      focus-within:outline-2
      focus-within:-outline-offset-2
      ${hasErrors ? 'focus-within:outline-red-500' : 'focus-within:outline-blue-600'}
      rounded-md
      block
      w-full
      mt-3
      border-none
      bg-neutral-50 text-neutral-900
      text-sm/6
      shadow-sm
      p-0.5
      `}
      >
        <textarea ref={textareaRef} />
      </div>
      <style>{`
        /* Stili base Jodit */
        .jodit {
          color: #000;
        }
        .jodit * {
          color-scheme: light !important;
        }

        /* Contro-reset Tailwind per contenuti editor */
        .jodit-wysiwyg h1 {
          font-size: 2rem !important;
          font-weight: 700 !important;
          line-height: 1.2 !important;
          margin: 1.5rem 0 0.75rem 0 !important;
          color: #111827 !important;
        }

        .jodit-wysiwyg h2 {
          font-size: 1.5rem !important;
          font-weight: 600 !important;
          line-height: 1.3 !important;
          margin: 1.25rem 0 0.5rem 0 !important;
          color: #111827 !important;
        }

        .jodit-wysiwyg h3 {
          font-size: 1.25rem !important;
          font-weight: 600 !important;
          line-height: 1.4 !important;
          margin: 1rem 0 0.5rem 0 !important;
          color: #111827 !important;
        }

        .jodit-wysiwyg p {
          margin: 0.75rem 0 !important;
          line-height: 1.6 !important;
          color: #374151 !important;
        }

        .jodit-wysiwyg strong {
          font-weight: 700 !important;
        }

        .jodit-wysiwyg em {
          font-style: italic !important;
        }

        .jodit-wysiwyg ul {
          list-style-type: disc !important;
          margin: 1rem 0 !important;
          padding-left: 2rem !important;
        }

        .jodit-wysiwyg ol {
          list-style-type: decimal !important;
          margin: 1rem 0 !important;
          padding-left: 2rem !important;
        }

        .jodit-wysiwyg li {
          margin: 0.25rem 0 !important;
          line-height: 1.6 !important;
        }

        .jodit-wysiwyg a {
          color: #3b82f6 !important;
          text-decoration: underline !important;
        }

        .jodit-wysiwyg a:hover {
          color: #2563eb !important;
        }

        .jodit-wysiwyg img {
          max-width: 100% !important;
          height: auto !important;
          margin: 1rem 0 !important;
          border-radius: 0.375rem !important;
        }

        .jodit-wysiwyg blockquote {
          border-left: 4px solid #e5e7eb !important;
          margin: 1.5rem 0 !important;
          padding: 0.5rem 0 0.5rem 1rem !important;
          color: #6b7280 !important;
          font-style: italic !important;
        }

        /* Stili toolbar */
        .jodit-toolbar {
          background: #f8fafc !important;
          border-bottom: 1px solid #e5e7eb !important;
        }

        .jodit-toolbar-button {
          border-radius: 0.375rem !important;
          margin: 0 0.125rem !important;
        }

        .jodit-toolbar-button:hover {
          background-color: #e2e8f0 !important;
        }

        .jodit-toolbar-button.jodit-toolbar-button-active {
          background-color: #3b82f6 !important;
          color: white !important;
        }

        /* Container dell'editor */
        .jodit-container {
          border: none !important;
        }

        .jodit-wysiwyg {
          padding: 1rem !important;
          font-family: system-ui, -apple-system, sans-serif !important;
        }

        /* Nasconde solo "Powered by Jodit" */
        .jodit-status-bar a[href*="jodit"],
        .jodit-status-bar .jodit-status-bar-link {
          display: none !important;
        }
      `}</style>
    </>
  );
};

export default RichTextEditor;
