import { RegisterOptions, FieldValues } from 'react-hook-form';
import { useFormContext, useController } from 'react-hook-form';
import { FormLabel, FormErrors, FormFieldInfo } from './index';
import {
  TextField as TextFieldAria,
  Input,
  TextFieldProps as TextFieldPropsAria,
} from 'react-aria-components';
import { useId } from 'react-aria';

interface TextFieldProps extends Omit<TextFieldPropsAria, 'isInvalid' | 'children'> {
  fieldName: string;
  label: string;
  validations?: {
    required?: boolean;
  };
}

const ColorField: React.FC<TextFieldProps> = ({ fieldName, label, validations, ...ariaProps }) => {
  const { required } = validations || {};
  const { control } = useFormContext();
  const rules: RegisterOptions<FieldValues, string> | undefined = {};

  if (required) {
    rules.required = 'errors.validations.required';
  }
  rules.pattern = {
    value: /^#[0-9A-Fa-f]{6}$/,
    message: 'errors.validations.pattern',
  };

  const {
    field,
    fieldState: { error },
  } = useController({
    name: fieldName,
    control,
    rules,
  });
  const describedById = useId().replace(/:/g, '--');
  return (
    <TextFieldAria type="color" isInvalid={!!error} {...ariaProps}>
      <FormLabel validations={validations}>{label}</FormLabel>

      <div
        className={`
        bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 p-3
        focus-within:outline-2
        focus-within:outline-offset-2 focus-within:outline-blue-600
        focus-within:dark:outline-sky-300 rounded-md block
        ${
          error
            ? `
        focus-within:ring-0
        focus-within:outline-2
        focus-within:outline-offset-2
        focus-within:outline-red-600!
        focus-within:dark:outline-red-500!
        ring-2
        ring-red-600
        dark:ring-red-500`
            : ''
        }
        `}
      >
        <div className="flex items-center gap-3">
          <div className="h-6 w-6 rounded-full overflow-hidden flex items-center ring-3 ring-black">
            <Input
              {...field}
              value={field.value || undefined}
              className={`h-10 w-10 p-0! -m-2 ${ariaProps.isReadOnly ? ' pointer-events-none' : ''}`}
            />
          </div>

          <input
            required={required}
            disabled={ariaProps.isDisabled}
            readOnly={ariaProps.isReadOnly}
            aria-invalid={!!error}
            type="text"
            value={field.value || ''}
            onChange={field.onChange}
            onBlur={field.onBlur}
            ref={field.ref}
            name={`${field.name}_hex`}
            placeholder="#RRGGBB"
            maxLength={7}
            pattern="^#[0-9A-Fa-f]{6}$"
            aria-label={`${label} - Hex CodeInput`}
            className="border-b-1 py-0.5 w-[5em] font-mono focus:outline-none bg-transparent"
            aria-describedby={describedById}
          />
        </div>
      </div>
      <div id={describedById}>
        {!error && <FormFieldInfo validations={validations || {}} />}
        <FormErrors error={error} />
      </div>
    </TextFieldAria>
  );
};

export { ColorField };
