import { useEffect, useRef, useState } from 'react';
import { RegisterOptions, FieldValues } from 'react-hook-form';
import { useFormContext, useController } from 'react-hook-form';
import { Duration, serialize } from 'tinyduration';
import { useTranslation } from 'react-i18next';
import { FormLabel, FormErrors, FormFieldInfo } from './index';
import {
  TextField as TextFieldAria,
  Input,
  TextFieldProps as TextFieldPropsAria,
} from 'react-aria-components';
import { useId } from 'react-aria';

const durationToMs = (duration: Duration): number | undefined => {
  if (duration === undefined) {
    return undefined;
  }
  const { days, hours, minutes, seconds } = duration;
  if (
    (days === undefined || isNaN(days)) &&
    (hours === undefined || isNaN(hours)) &&
    (minutes === undefined || isNaN(minutes)) &&
    (seconds === undefined || isNaN(seconds))
  ) {
    return undefined;
  }
  const ms =
    ((days || 0) * 24 * 60 * 60 + (hours || 0) * 60 * 60 + (minutes || 0) * 60 + (seconds || 0)) *
    1000;
  return ms;
};

const msToDuration = (ms: number | undefined): Duration | undefined => {
  if (ms === undefined) {
    return undefined;
  }
  if (ms < 0) {
    throw new Error('Duration cannot be negative');
  }
  if (ms === 0) {
    return {
      days: 0,
      hours: 0,
      minutes: 0,
      seconds: 0,
    };
  }
  const days = Math.floor(ms / (24 * 60 * 60 * 1000));
  ms %= 24 * 60 * 60 * 1000;
  const hours = Math.floor(ms / (60 * 60 * 1000));
  ms %= 60 * 60 * 1000;
  const minutes = Math.floor(ms / (60 * 1000));
  ms %= 60 * 1000;
  const seconds = ms / 1000;
  const duration: Duration = {
    days: days,
    hours: hours,
    minutes: minutes,
    seconds: seconds,
  };
  return duration;
};

const inputIsoClassName = (hasErrors = false) =>
  `scheme-light dark:scheme-dark outline-2 outline-dashed ${hasErrors ? 'outline-red-600 dark:outline-red-500' : 'outline-slate-200 dark:outline-slate-600 -outline-offset-2'} rounded-md block w-full border-none  text-slate-800  dark:text-slate-50 placeholder-slate-600 dark:placeholder-slate-300 text-sm/6 py-1.5 px-3`;

interface DurationFieldProps
  extends Omit<TextFieldPropsAria, 'type' | 'isInvalid' | 'isRequired' | 'children'> {
  fieldName: string;
  label: string;
  placeholder?: string;
  step?: 1 | 0.1 | 0.01;
  showIso?: boolean;
  validations?: {
    required?: boolean;
  };
}

const DurationField: React.FC<DurationFieldProps> = ({
  fieldName,
  label,
  showIso = true,
  validations,
  ...props
}) => {
  const { t } = useTranslation();
  const { required } = validations || {};
  const { control, setValue } = useFormContext();
  const rules: RegisterOptions<FieldValues, string> | undefined = {};

  if (required) {
    rules.required = 'errors.validations.required';
  }

  const {
    field,
    fieldState: { error },
  } = useController({
    name: fieldName,
    control,
    rules,
  });

  const opts: RegisterOptions<FieldValues, string> | undefined = {
    valueAsNumber: true,
    min: {
      value: 0,
      message: 'errors.validations.min:0',
    },
  };

  if (required) {
    opts.required = 'errors.validations.required';
  }

  const [initialized, setInitialized] = useState(false);
  const [days, setDays] = useState<number | string>('');
  const [hours, setHours] = useState<number | string>('');
  const [minutes, setMinutes] = useState<number | string>('');
  const [seconds, setSeconds] = useState<number | string>('');
  const [milliseconds, setMilliseconds] = useState<number | undefined>(undefined);

  useEffect(() => {
    if (
      (days === '' || Number.isNaN(days)) &&
      (hours === '' || Number.isNaN(hours)) &&
      (minutes === '' || Number.isNaN(minutes)) &&
      (seconds === '' || Number.isNaN(seconds))
    ) {
      setMilliseconds(undefined);
    } else {
      setMilliseconds(
        durationToMs({
          days: parseInt(`${days}`, 10),
          hours: parseInt(`${hours}`, 10),
          minutes: parseInt(`${minutes}`, 10),
          seconds: parseFloat(`${seconds}`),
        })
      );
    }
  }, [days, hours, minutes, seconds]);

  useEffect(() => {
    if (!initialized && field.value !== undefined) {
      setMilliseconds(field.value);
      const duration = msToDuration(field.value);
      setDays(duration?.days ?? '');
      setHours(duration?.hours ?? '');
      setMinutes(duration?.minutes ?? '');
      setSeconds(duration?.seconds ?? '');
      setInitialized(true);
    }
  }, [fieldName, field, initialized, milliseconds]);

  useEffect(() => {
    setValue(fieldName, milliseconds);
  }, [milliseconds, setValue, fieldName]);

  const inputRef = useRef<HTMLInputElement>(null);
  const dId = useId();
  const hId = useId();
  const mId = useId();
  const sId = useId();
  const iId = useId();
  const descriptionId = useId();

  return (
    <TextFieldAria {...props} isInvalid={!!error}>
      <FormLabel validations={validations}>{label}</FormLabel>
      <div className="flex flex-col md:flex-row gap-2">
        <div className={showIso ? 'md:w-1/5' : 'md:w-1/4'}>
          <label id={`${dId}-label`} htmlFor={dId} className="block text-xs">
            {t('fields.duration.days')}
          </label>
          <input
            id={dId}
            aria-labelledby={`${dId}-label`}
            aria-describedby={descriptionId}
            aria-invalid={!!error}
            disabled={props.isDisabled}
            readOnly={props.isReadOnly}
            ref={inputRef}
            type="number"
            placeholder={t('fields.duration.days')}
            value={days}
            step={1}
            min={0}
            className={error ? 'form-field-error' : 'form-field'}
            onChange={(e) => {
              if (Number.isNaN(parseInt(e.target.value, 10))) {
                setDays('');
                return;
              }
              setDays(parseInt(e.target.value, 10));
            }}
          />
        </div>
        <div className={showIso ? 'md:w-1/5' : 'md:w-1/4'}>
          <label id={`${hId}-label`} htmlFor={hId} className="block text-xs">
            {t('fields.duration.hours')}
          </label>
          <input
            id={hId}
            aria-labelledby={`${hId}-label`}
            aria-describedby={descriptionId}
            aria-invalid={!!error}
            disabled={props.isDisabled}
            readOnly={props.isReadOnly}
            type="number"
            placeholder={t('fields.duration.hours')}
            value={hours ?? ''}
            step={1}
            min={0}
            max={23}
            className={error ? 'form-field-error' : 'form-field'}
            onChange={(e) => {
              if (Number.isNaN(parseInt(e.target.value, 10))) {
                setHours('');
                return;
              }
              setHours(parseInt(e.target.value, 10));
            }}
          />
        </div>
        <div className={showIso ? 'md:w-1/5' : 'md:w-1/4'}>
          <label id={`${mId}-label`} htmlFor={mId} className="block text-xs">
            {t('fields.duration.minutes')}
          </label>
          <input
            id={mId}
            aria-labelledby={`${mId}-label`}
            aria-describedby={descriptionId}
            aria-invalid={!!error}
            disabled={props.isDisabled}
            readOnly={props.isReadOnly}
            type="number"
            placeholder={t('fields.duration.minutes')}
            value={minutes ?? ''}
            step={1}
            min={0}
            max={59}
            className={error ? 'form-field-error' : 'form-field'}
            onChange={(e) => {
              if (Number.isNaN(parseInt(e.target.value, 10))) {
                setMinutes('');
                return;
              }
              setMinutes(parseInt(e.target.value, 10));
            }}
          />
        </div>
        <div className={showIso ? 'md:w-1/5' : 'md:w-1/4'}>
          <label id={`${sId}-label`} htmlFor={sId} className="block text-xs">
            {t('fields.duration.seconds')}
          </label>
          <input
            id={sId}
            aria-labelledby={`${sId}-label`}
            aria-describedby={descriptionId}
            aria-invalid={!!error}
            disabled={props.isDisabled}
            readOnly={props.isReadOnly}
            type="number"
            placeholder={t('fields.duration.seconds')}
            value={seconds ?? ''}
            min={0}
            max={59.999}
            step={1}
            className={error ? 'form-field-error' : 'form-field'}
            onChange={(e) => {
              if (Number.isNaN(parseFloat(e.target.value))) {
                setSeconds('');
                return;
              }
              setSeconds(parseFloat(e.target.value));
            }}
          />
        </div>
        {showIso && (
          <div className="md:w-1/5">
            <label id={`${iId}-label`} htmlFor={iId} className="block text-xs">
              ISO 8601
            </label>
            <input
              id={iId}
              aria-labelledby={`${iId}-label`}
              aria-describedby={descriptionId}
              aria-invalid={!!error}
              required={required}
              tabIndex={-1}
              disabled={true}
              readOnly={true}
              type="text"
              placeholder="--"
              value={
                milliseconds === undefined || msToDuration(milliseconds) === undefined
                  ? ''
                  : serialize(msToDuration(milliseconds) ?? {})
              }
              className={`${inputIsoClassName(!!error)}`}
            />
          </div>
        )}
        <div className="size-0 overflow-hidden">
          <Input
            tabIndex={-1}
            aria-hidden="true"
            {...field}
            className={`${inputIsoClassName(!!error)}`}
            type="number"
            onFocus={() => inputRef.current?.focus()}
          />
        </div>
      </div>
      <div id={descriptionId}>
        {!error && <FormFieldInfo validations={validations || {}} />}
        <FormErrors error={error} />
      </div>
    </TextFieldAria>
  );
};

interface DurationFieldViewerProps {
  duration: number | null | undefined;
  format?: 'iso' | 'verbose' | 'raw' | ((duration: Duration) => string);
}

const DurationFieldViewer: React.FC<DurationFieldViewerProps> = ({ duration, format = 'iso' }) => {
  const { t } = useTranslation();
  if (duration === null || duration === undefined || msToDuration(duration) === undefined) {
    return <span>--</span>;
  }
  if (typeof format === 'function') {
    return <span>{format(msToDuration(duration) ?? {})}</span>;
  }
  if (format === 'verbose') {
    const dur = msToDuration(duration) ?? {};
    const parts = [];
    if (dur.days !== undefined && dur.days > 0) {
      parts.push(`${dur.days} ${t(`fields.duration.day${dur.days > 1 ? 's' : ''}`).toLowerCase()}`);
    }
    if (dur.hours !== undefined && dur.hours > 0) {
      parts.push(
        `${dur.hours} ${t(`fields.duration.hour${dur.hours > 1 ? 's' : ''}`).toLowerCase()}`
      );
    }
    if (dur.minutes !== undefined && dur.minutes > 0) {
      parts.push(
        `${dur.minutes} ${t(`fields.duration.minute${dur.minutes > 1 ? 's' : ''}`).toLowerCase()}`
      );
    }
    if (dur.seconds !== undefined && dur.seconds > 0) {
      parts.push(
        `${dur.seconds} ${t(`fields.duration.second${dur.seconds > 1 ? 's' : ''}`).toLowerCase()}`
      );
    }
    return <span>{parts.join(', ') || '0 seconds'}</span>;
  }
  if (format === 'raw') {
    return <span>{duration}</span>;
  }
  if (format !== 'iso') {
    throw new Error(`Unsupported format: ${format}`);
  }
  return <span>{serialize(msToDuration(duration) ?? {})}</span>;
};

export { DurationField, DurationFieldViewer };
export type { Duration };
