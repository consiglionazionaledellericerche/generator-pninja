import { useTranslation } from 'react-i18next';
import { v4 as uuidv4 } from 'uuid';
import { RefreshCw } from 'lucide-react';
import { RegisterOptions, FieldValues } from 'react-hook-form';
import { useFormContext, useController } from 'react-hook-form';
import { FormLabelAria as FormLabel, FormErrorsAria as FormErrors } from './index';
import {
  Button,
  TextField as TextFieldAria,
  Input,
  TextFieldProps as TextFieldPropsAria,
} from 'react-aria-components';

const inputClassName = (hasErrors = false) =>
  `scheme-light dark:scheme-dark outline-0${hasErrors ? ' outline-2 -outline-offset-2 outline-red-600 dark:outline-red-500' : ''} focus:outline-2 focus:-outline-offset-2 ${hasErrors ? 'focus:outline-red-600 focus:dark:outline-red-500' : 'focus:outline-blue-600'} rounded-md block w-full mt-3 border-none bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 placeholder-slate-600 dark:placeholder-slate-300 text-sm/6 py-1.5 px-3`;

interface UuidFieldProps extends Omit<TextFieldPropsAria, 'isInvalid' | 'children'> {
  autoGenerate?: boolean;
  fieldName: string;
  label: string;
  placeholder?: string;
  validations?: {
    required?: boolean;
  };
}

const UuidField: React.FC<UuidFieldProps> = ({
  autoGenerate = true,
  fieldName,
  label,
  validations,
  ...ariaProps
}) => {
  const { t } = useTranslation();
  const { required } = validations || {};
  const { control, setValue, getValues } = useFormContext();
  const rules: RegisterOptions<FieldValues, string> | undefined = {};

  if (required) {
    rules.required = 'errors.validations.required';
  }
  rules.pattern = {
    value: /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i,
    message: 'errors.validations.pattern',
  };

  const {
    field,
    fieldState: { error },
  } = useController({
    name: fieldName,
    control,
    rules,
    defaultValue: getValues(fieldName) || (autoGenerate ? uuidv4() : ''),
  });

  return (
    <TextFieldAria isInvalid={!!error} {...ariaProps}>
      <FormLabel validations={validations}>{label}</FormLabel>
      <div className="grid grid-cols-1">
        <Input
          {...field}
          value={field.value || ''}
          className={`${inputClassName(!!error)} col-start-1 row-start-1`}
          readOnly={autoGenerate}
        />
        {!autoGenerate && (
          <Button
            onClick={() => {
              setValue(fieldName, uuidv4(), { shouldValidate: true, shouldDirty: true });
            }}
            className="cursor-pointer col-start-1 row-start-1 mt-3 me-4 self-center justify-self-end size-5 sm:size-4"
            aria-label={t('actions.generateUUID')}
          >
            <RefreshCw className="h-full" />
          </Button>
        )}
      </div>
      <FormErrors error={error} />
    </TextFieldAria>
  );
};

export { UuidField };
