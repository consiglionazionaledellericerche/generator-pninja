import { useTranslation } from 'react-i18next';
import prettyBytes from 'pretty-bytes';
import { FileIcon, FileImageIcon, EditIcon, Trash2Icon, Undo2Icon, InfoIcon } from 'lucide-react';
import { useState, useRef } from 'react';
import { useFormContext } from 'react-hook-form';
import { FormLabel } from './FormLabel';
import { FormErrors } from './FormErrors';

type TransformedFileData = {
  data: string;
  mimeType: string;
  originalName: string;
  size: number;
  delete: boolean;
};

const inputClassName = (hasErrors = false) =>
  `scheme-light dark:scheme-dark outline-0${hasErrors ? ' outline-2 -outline-offset-2 outline-red-500' : ''} focus:outline-2 focus:-outline-offset-2 ${hasErrors ? 'focus:outline-red-500' : 'focus:outline-blue-600'} rounded-md block w-full mt-3 border-none bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 placeholder-slate-600 dark:placeholder-slate-300 text-sm/6 py-1.5 px-3`;

interface FileFieldProps {
  accept?: string;
  entity?: unknown;
  fieldName: string;
  label: string;
  validations?: {
    required?: boolean;
    minbytes?: number;
    maxbytes?: number;
  };
}

function fileToBase64(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const result = reader.result;
      if (typeof result !== 'string') {
        reject(new Error('Failed to read file as data URL'));
        return;
      }
      // Removes "data:mime/type;base64," and keeps only the base64
      const base64 = result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = () => reject(new Error('Error reading file'));
    reader.readAsDataURL(file);
  });
}

const FileField: React.FC<FileFieldProps> = ({ accept, entity, fieldName, label, validations }) => {
  const { t } = useTranslation();
  const entityData = entity as Record<string, unknown>;
  const hasFile = entityData?.[`${fieldName}_name`] || false;
  const [shouldShowInput, setShouldShowInput] = useState(!hasFile);
  const [isMarkedForDeletion, setIsMarkedForDeletion] = useState(false);
  const { required, minbytes, maxbytes } = validations || {};
  const inputRef = useRef<HTMLInputElement>(null);
  const {
    register,
    setValue,
    trigger,
    formState: { errors },
  } = useFormContext();

  const markForDeletion = (mark: boolean) => {
    setIsMarkedForDeletion(mark);
    setValue(fieldName, mark ? { delete: true } : null);
    setTimeout(() => {
      trigger(fieldName);
    }, 0);
  };

  const registerProps = register(fieldName, {
    validate: (value: unknown | undefined) => {
      const fileData = value as TransformedFileData | null;

      if (fileData?.mimeType && !fileData.mimeType.startsWith(accept?.replace(/\/\*$/, '') ?? '')) {
        return `errors.validations.file.invalidType:${accept}:${fileData.mimeType}`;
      }
      if (typeof fileData?.size === 'number' && minbytes && fileData?.size < minbytes) {
        return `errors.validations.file.minSize:${prettyBytes(minbytes)}:${prettyBytes(fileData?.size)}`;
      }
      if (typeof fileData?.size === 'number' && maxbytes && fileData?.size > maxbytes) {
        return `errors.validations.file.maxSize:${prettyBytes(maxbytes)}:${prettyBytes(fileData?.size)}`;
      }
      if (required && (fileData?.delete || (!fileData && !entityData?.[`${fieldName}_name`]))) {
        return 'errors.validations.file.required';
      }
      return true;
    },
  });

  // Handler personalizzato per trasformare e salvare
  const handleFileChange = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;

    if (!file) {
      setValue(fieldName, null);
      setTimeout(() => {
        trigger(fieldName);
      }, 0);
      return;
    }

    try {
      const fileData = await fileToBase64(file);
      const transformedValue: TransformedFileData = {
        data: fileData,
        mimeType: file.type,
        originalName: file.name,
        size: file.size,
        delete: isMarkedForDeletion,
      };

      setValue(fieldName, transformedValue);
      setTimeout(() => {
        trigger(fieldName);
      }, 0);
    } catch (error) {
      console.error('Error converting file to base64:', error);
      setValue(fieldName, null);
      setTimeout(() => {
        trigger(fieldName);
      }, 0);
    }
  };

  const undoEdit = () => {
    setShouldShowInput(false);
    setValue(fieldName, null);
    // Reset the input value
    const input = document.querySelector(`[name=${fieldName}]`) as HTMLInputElement;
    if (input) input.value = '';
    setTimeout(() => {
      trigger(fieldName);
    }, 0);
  };

  return (
    <>
      <FormLabel htmlFor={fieldName} label={label} validations={validations} />
      <div>
        {hasFile && !shouldShowInput && !isMarkedForDeletion && (
          <div className="mt-3 p-3 bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-slate-200 rounded-md">
            <div className="flex items-center justify-between">
              <a
                href={`${location.pathname.replace('entities', 'api').replace('edit/', '')}/${fieldName}/${entityData?.[`${fieldName}_name`]}`}
                className="hover:underline flex items-center"
                target="_blank"
                rel="noopener noreferrer"
              >
                {(entityData?.[`${fieldName}_type`] as string)?.startsWith('image/') ? (
                  <FileImageIcon className="me-2 h-4 w-4" />
                ) : (
                  <FileIcon className="me-2 h-4 w-4" />
                )}
                {t('actions.crud.file.viewOrDownload')}{' '}
                {entityData?.[`${fieldName}_name`] as string}
              </a>
              <div className="flex items-center gap-2">
                <button
                  type="button"
                  onClick={() => setShouldShowInput(true)}
                  className="flex items-center text-sm  cursor-pointer font-medium hover:text-slate-900"
                >
                  <EditIcon className="me-1 h-4 w-4" />
                  {t('actions.crud.edit')}
                </button>
                <button
                  type="button"
                  onClick={() => markForDeletion(true)}
                  className="flex items-center text-sm  cursor-pointer font-medium hover:text-slate-900"
                >
                  <Trash2Icon className="me-1 h-4 w-4" />
                  {t('actions.crud.delete')}
                </button>
              </div>
            </div>
          </div>
        )}

        {isMarkedForDeletion && (
          <div className="mt-3 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-md">
            <div className="flex items-center justify-between">
              <div className="flex items-center text-red-800 dark:text-red-200">
                <Trash2Icon className="me-2 h-4 w-4" />
                <span className="text-sm font-medium">
                  {t('actions.crud.file.markedForDeletion')}
                </span>
              </div>
              <button
                type="button"
                onClick={() => markForDeletion(false)}
                className="flex items-center text-sm text-slate-900 dark:text-gray-300 cursor-pointer font-medium hover:text-slate-700 hover:dark:text-gray-100"
              >
                <Undo2Icon className="me-2 h-4 w-4" />
                {t('common.undo')}
              </button>
            </div>
          </div>
        )}

        <div className={shouldShowInput && !isMarkedForDeletion ? 'block' : 'hidden'}>
          <div className="mt-3">
            {hasFile && shouldShowInput && (
              <div className="mt-3 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-md">
                <div className="flex items-center justify-between">
                  <div className="flex items-center text-yellow-800 dark:text-yellow-200">
                    <InfoIcon className="me-2 h-4 w-4" />
                    <span className="text-sm font-medium">
                      {t('actions.crud.file.replaceWarning')}
                    </span>
                  </div>
                  <button
                    type="button"
                    onClick={() => undoEdit()}
                    className="flex items-center text-sm text-slate-900 dark:text-gray-300 cursor-pointer font-medium hover:text-slate-700 hover:dark:text-gray-100"
                  >
                    <Undo2Icon className="me-2 h-4 w-4" />
                    {t('common.cancel')}
                  </button>
                </div>
              </div>
            )}
            <input
              type="file"
              id={fieldName}
              accept={accept ?? '*/*'}
              {...registerProps}
              onChange={handleFileChange}
              ref={inputRef}
              className={inputClassName(!!errors?.[fieldName]?.message)}
            />
          </div>
        </div>
      </div>
      <FormErrors errors={errors} fieldName={fieldName} />
    </>
  );
};

export { FileField };
