import { useState, useEffect } from 'react';
import { Link, useLocation } from 'react-router-dom';
import { Button, Menu as MenuItems, MenuItem, MenuTrigger, Popover } from 'react-aria-components';
import { ChevronDown } from 'lucide-react';
import { useTranslation } from 'react-i18next';
import { DarkModeToggle } from './DarkModeToggle';
import { LangSelect } from './LangSelect';
import { useAuthState } from '../hooks/useAuthState';
import LoginButton from './LoginButton';
import LogoutButton from './LogoutButton';
import appLogo from '../assets/logo.svg';
const Menu: React.FC = () => {
  const { isAuthenticated } = useAuthState();
  const { t } = useTranslation();
  const location = useLocation();
<%  if (entities.length > 1) { -%>
  const [activeEntity, setActiveEntity] = useState<string | null>(null);
<% } -%>
  const isActive = (path: string) =>
    location.pathname === path
      ? ' bg-slate-300 text-slate-900 dark:bg-gray-700 dark:text-gray-300'
      : '';
  const [menuVisible, setMenuVisible] = useState(false);
  const htmlElement = document.querySelector('html');
  useEffect(() => {
    if (htmlElement) {
      htmlElement.addEventListener('click', () => setMenuVisible(false));
    }
  }, [htmlElement]);
  useEffect(() => {
<%  if (entities.length > 1) { -%>
    setActiveEntity(null);
<%  entities.forEach((entity, index) => {-%>
    if (location.pathname === '/entities/<%- to.slug(pluralize(entity.name)) %>') setActiveEntity('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>');
<%  });-%>
<% } -%>
    setMenuVisible(false); // Close the menu when the location changes
  }, [location]);
  return (
    <nav className="nav-bar">
      <Link to="/" className="rounded-full hover:ring-4 focus:outline-none focus-visible:ring-4">
        <img className="h-8 w-8 max-w-8" src={appLogo} alt="" />
      </Link>
      <Link to="/" className="hover:text-sky-600 hover:dark:text-sky-400 text-xl">
        {t('appName')}
      </Link>
      <span className="grow"></span>
      <button
        type="button"
        className={`inline-flex items-center p-0 w-10 h-10 justify-center rounded-md md:hidden hover:ring-4 focus:outline-none focus-visible:ring-4 ${menuVisible ? ' bg-slate-300 text-slate-900 dark:bg-gray-700 dark:text-gray-300' : ''}`}
        aria-expanded={menuVisible ? 'true' : 'false'}
        onClick={(e) => {
          e.stopPropagation();
          setMenuVisible(!menuVisible);
        }}
      >
        <span className="sr-only">Open main menu</span>
        <svg
          className="w-5 h-5"
          aria-hidden="true"
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 17 14"
        >
          <path
            stroke="currentColor"
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth="2"
            d="M1 1h15M1 7h15M1 13h15"
          />
        </svg>
      </button>
      <div
        className={`w-auto absolute ${menuVisible ? 'block' : 'hidden'} md:block md:static top-16 left-4 right-4`}
      >
        <div className="flex flex-row flex-wrap items-center justify-between gap-1 md:gap-4 rounded-lg p-4 md:h-16 md:p-0 bg-slate-400 dark:bg-gray-600 md:bg-transparent md:dark:bg-transparent">
          <Link
            className={`w-full md:w-auto nav-bar-link${isActive('/')}`}
            to="/">
            {t('pages.Home')}
          </Link>
          <Link className={`w-full md:w-auto nav-bar-link${isActive('/admin')}`} to="/admin">
            Admin
          </Link>
          <Link className={`w-full md:w-auto nav-bar-link${isActive('/apps-admin')}`} to="/apps-admin">
            Apps admin
          </Link>
<%  if (entities.length > 1) { -%>
          <MenuTrigger>
            <Button
              aria-label="Menu"
              className={
                'w-full md:w-auto inline-flex gap-1 items-center justify-center nav-bar-link'
              }
            >
              {t(activeEntity || 'entities.entities')} <ChevronDown size={16} />
            </Button>
            <Popover className="w-full md:w-auto max-w-[80%] md:min-w-60 rounded-md shadow-lg ring-1 ring-black/25 dark:ring-white/25 bg-slate-100 text-slate-900 dark:bg-gray-900 dark:text-gray-300">
              <MenuItems>
<%            entities.forEach((entity, index) => {-%>
                <MenuItem>
                  <Link className={`rounded-md m-1 hover:ring-4 data-[focus]:ring-4 block p-2${isActive('/entities/<%- to.slug(pluralize(entity.name)) %>')}`} to="/entities/<%- to.slug(pluralize(entity.name)) %>">
                    {t('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>')}
                  </Link>
                </MenuItem>
<%            });-%>
              </MenuItems>
            </Popover>
          </MenuTrigger>
<% } else { -%>
<%      entities.forEach((entity, index) => {-%>
          <Link className={`w-full md:w-auto nav-bar-link${isActive('/entities/<%- to.slug(pluralize(entity.name)) %>')}`} to="/entities/<%- to.slug(pluralize(entity.name)) %>">
            {t('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>')}
          </Link>
<%      });-%>
<% } %>
          <div className="flex gap-1 md:gap-4 w-full md:w-auto">
            <LangSelect />
            <DarkModeToggle />
            {!isAuthenticated && <LoginButton />}
            {isAuthenticated && <LogoutButton />}
          </div>
        </div>
      </div>
    </nav>
  );
};

export default Menu;
