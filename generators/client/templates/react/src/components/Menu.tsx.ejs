import { useState, useEffect, useCallback } from 'react';
import { Link, useLocation } from 'react-router-dom';
<%  if (entities.length > 1) { -%>
import { Button, Menu as MenuItems, MenuItem, MenuTrigger, Popover } from 'react-aria-components';
import { ChevronDown, UserCog } from 'lucide-react';
<% } -%>
import { useTranslation } from 'react-i18next';
import { DarkModeToggle } from './DarkModeToggle';
<% if (withLangSelect) { -%>
import { LangSelect } from './LangSelect';
<% } -%>
import { useAuthState } from '../hooks/useAuthState';
import { Can } from './Can';
import LoginButton from './LoginButton';
import LogoutButton from './LogoutButton';
import appLogo from '../assets/logo.svg';
const Menu: React.FC = () => {
  const { isAuthenticated } = useAuthState();
  const { t } = useTranslation();
  const location = useLocation();
  const menuIsActiveClass = ' bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100';
<%  if (entities.length > 1) { -%>
  const menuItemIsActiveClass =
    ' bg-slate-300 text-slate-800 dark:bg-slate-700 dark:text-slate-200';
<%  } -%>
  const isActive = useCallback(
    (path: string) => location.pathname === path || location.pathname.startsWith(`${path}/`),
    [location.pathname]
  );
  const [menuVisible, setMenuVisible] = useState(false);
  const htmlElement = document.querySelector('html');
  useEffect(() => {
    if (htmlElement) {
      htmlElement.addEventListener('click', () => setMenuVisible(false));
    }
  }, [htmlElement]);

  return (
    <nav className="nav-bar">
      <Link
        aria-hidden="true"
        to="/"
        className="rounded-full focus:outline-none hover:ring-4 hover:ring-blue-600 hover:dark:ring-sky-300 focus-visible:ring-4 focus-visible:ring-blue-600 focus-visible:dark:ring-sky-300"
      >
        <img className="h-8 w-8 max-w-8" src={appLogo} alt="" />
      </Link>
      <Link
        to="/"
        className="rounded-md text-xl hover:text-black hover:dark:text-white hover:text-bold focus:outline-none focus-visible:ring-4 focus-visible:ring-blue-600 focus-visible:dark:ring-sky-300"
      >
        {t('appName')}
      </Link>
      <span className="grow"></span>
      <button
        type="button"
        className={`inline-flex items-center p-0 w-10 h-10 justify-center rounded-md md:hidden focus:outline-none focus-visible:ring-4 focus-visible:ring-blue-600 focus-visible:dark:ring-sky-300 bg-slate-300 text-slate-900 dark:bg-slate-700 dark:text-slate-300`}
        aria-expanded={menuVisible ? 'true' : 'false'}
        onClick={(e) => {
          e.stopPropagation();
          setMenuVisible(!menuVisible);
        }}
      >
        <span className="sr-only">{menuVisible ? 'Close main menu' : 'Open main menu'}</span>
        {menuVisible ? (
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M18 6 6 18" />
            <path d="m6 6 12 12" />
          </svg>
        ) : (
          <svg
            className="w-5 h-5"
            aria-hidden="true"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 17 14"
          >
            <path
              stroke="currentColor"
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M1 1h15M1 7h15M1 13h15"
            />
          </svg>
        )}
      </button>
      <div
        className={`w-auto absolute ${menuVisible ? 'block' : 'hidden'} md:block md:static top-16 left-4 right-4`}
      >
        <div className="flex flex-row flex-wrap items-center justify-between gap-1 md:gap-4 rounded-lg p-4 md:h-16 md:p-0 bg-slate-400 dark:bg-gray-600 md:bg-transparent md:dark:bg-transparent">
          <Link
            className={`w-full md:w-auto nav-bar-link${isActive('/') ? menuIsActiveClass : ''}`}
            to="/"
          >
            {t('pages.Home')}
          </Link>
<%  if (entities.length > 0) { -%>
          <Can
            any={[
<%    entities.forEach((entity, index) => {-%>
              { resource: '<%- entity.name %>', action: 'read' },
<%    });-%>
            ]}
          >
            <MenuTrigger>
              <Button
                aria-label={t('entities')}
                className="group w-full md:w-auto inline-flex gap-1 items-center justify-center nav-bar-link"
              >
                {t('entities')} <ChevronDown size={16} className="group-aria-expanded:rotate-180 duration-100" />
              </Button>
              <Popover className="w-full md:w-auto max-w-[80%] md:min-w-60 rounded-md bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 ring-1 ring-black/25 dark:ring-white/25 shadow-md dark:shadow-md/70 max-h-[60vh] overflow-y-auto thin-scrollbar">
                <MenuItems className="outline-0">
<%    entities.forEach((entity, index) => {-%>
                  <Can action="read" resource="<%- entity.name %>">
                    <MenuItem
                      href="/entities/<%- to.slug(pluralize(entity.name)) %>"
                      id="<%- to.slug(pluralize(entity.name)) %>"
                      className={`cursor-pointer outline-0 rounded-md m-1 focus:ring-4 focus:ring-blue-600 focus:dark:ring-sky-300 block p-2${isActive('/entities/<%- to.slug(pluralize(entity.name)) %>') ? menuItemIsActiveClass : ''}`}
                    >
                      {t('entities:<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>')}
                    </MenuItem>
                  </Can>
<%    });-%>
                </MenuItems>
              </Popover>
            </MenuTrigger>
          </Can>
<% } %>
          <Can
            any={[
              { resource: 'AcRule', action: 'read' },
            ]}
          >
            <MenuTrigger>
              <Button
                aria-label={t('entities')}
                className="group w-full md:w-auto inline-flex gap-1 items-center justify-center nav-bar-link"
              >
                <UserCog aria-hidden size={16} />
                <span className="w-0 overflow-hidden">{t('Admin')}</span>
                <ChevronDown size={16} className="group-aria-expanded:rotate-180 duration-100" />
              </Button>
              <Popover className="w-full md:w-auto max-w-[80%] md:min-w-60 rounded-md bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 ring-1 ring-black/25 dark:ring-white/25 shadow-md dark:shadow-md/70 max-h-[60vh] overflow-y-auto thin-scrollbar">
                <MenuItems className="outline-0">
                  <Can action="read" resource="AcRule">
                    <MenuItem
                      href="/entities/ac-rules"
                      id="ac-rules"
                      className={`cursor-pointer outline-0 rounded-md m-1 focus:ring-4 focus:ring-blue-600 focus:dark:ring-sky-300 block p-2${isActive('/entities/ac-rules') ? menuItemIsActiveClass : ''}`}
                    >
                      {t('entities:ac_rule.AcRules')}
                    </MenuItem>
                  </Can>
                </MenuItems>
              </Popover>
            </MenuTrigger>
          </Can>

          <div className="flex flex-row flex-wrap items-center justify-end gap-1 md:gap-4 w-full md:w-auto">
<% if (withLangSelect) { -%>
            <LangSelect />
<% } -%>
            <DarkModeToggle />
            {!isAuthenticated && <LoginButton />}
            {isAuthenticated && <LogoutButton />}
          </div>
        </div>
      </div>
    </nav>
  );
};

export default Menu;
