import { INotification, useNotifications } from '../contexts/NotificationContext';
import { useEffect, useState, useMemo, useRef } from 'react';
import { useTranslation } from 'react-i18next';
import { useId } from 'react-aria';
import { Icon } from './Icon';

type ToastVariant = 'success' | 'error' | 'warning' | 'info';
const toastIcons: Record<ToastVariant, string> = {
  info: 'info',
  error: 'error',
  success: 'check_circle',
  warning: 'warning',
};

export function Toast({ notification }: { notification: INotification }) {
  const { t } = useTranslation();
  const {
    removeNotification,
    getRemainingTime,
    getRemainingPercentage,
    hasAutoClose,
    pauseNotification,
    resumeNotification,
  } = useNotifications();

  const duration = notification.duration ?? 0;
  const [remainingTime, setRemainingTime] = useState(duration);
  const [remainingPercentage, setRemainingPercentage] = useState(duration);
  const [isPaused, setIsPaused] = useState(false);
  const [showMore, setShowMore] = useState(false);
  const hasTimer = hasAutoClose(notification.id);

  const colors = useMemo(
    () =>
      ({
        success: {
          main: 'bg-green-700 text-white',
          details: 'bg-green-800 text-white',
          progress: 'border-green-500',
        },
        error: {
          main: 'bg-red-600 text-white',
          details: 'bg-red-700 text-white',
          progress: 'border-red-400',
        },
        warning: {
          main: 'bg-yellow-500 text-yellow-900',
          details: 'bg-yellow-600 text-yellow-950',
          progress: 'border-yellow-300',
        },
        info: {
          main: 'bg-blue-600 text-white',
          details: 'bg-blue-700 text-white',
          progress: 'border-blue-400',
        },
      })[notification.type],
    [notification.type]
  );

  useEffect(() => {
    if (!hasTimer || isPaused) return;

    const timer = setInterval(() => {
      const remaining = getRemainingTime(notification.id);
      setRemainingTime(remaining);
      const percentage = getRemainingPercentage(notification.id);
      setRemainingPercentage(percentage);
    }, 100);

    return () => clearInterval(timer);
  }, [isPaused, notification.id, getRemainingTime, hasTimer]);

  const detailsId = useId();
  const showmoreRef = useRef<HTMLButtonElement>(null);
  const closeRef = useRef<HTMLButtonElement>(null);
  const playRef = useRef<HTMLButtonElement>(null);
  const previousFocusRef = useRef<HTMLElement | null>(null);

  useEffect(() => {
    // Save previous focus only for urgent toasts
    if (notification.type === 'warning' || notification.type === 'error') {
      previousFocusRef.current = document.activeElement as HTMLElement;
      if (['error', 'warning'].includes(notification.type)) {
        closeRef.current?.focus();
      }
    }

    // Cleanup: restore focus when toast closes
    return () => {
      if (
        previousFocusRef.current &&
        (notification.type === 'warning' || notification.type === 'error')
      ) {
        previousFocusRef.current.focus();
      }
    };
  }, [notification.type]);

  return (
    <div
      role={['error', 'warning'].includes(notification.type) ? 'alert' : 'status'}
      className={`${colors.main} rounded-lg shadow-lg dark:shadow-lg/70 w-[80vw] lg:w-3xl overflow-hidden`}
      onClick={(e) => {
        e.stopPropagation();
        setIsPaused(true);
        pauseNotification(notification.id);
      }}
    >
      <div className="p-4 flex justify-between items-start flex-row-reverse">
        <div className="flex items-center ms-2 gap-2 shrink-0">
          <button
            ref={closeRef}
            aria-label={t('actions.closeNotification')}
            onClick={() => removeNotification(notification.id)}
            className="cursor-pointer rounded-full focus:outline-2 focus:-outline-offset-1 focus:outline-inherit focus:rounded-full p-1 -m-1"
          >
            <Icon icon="close" size={6} className="block!" />
          </button>
        </div>
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <Icon icon={toastIcons[notification.type]} size={8} className="me-2" />
            <div>{notification.message}</div>
          </div>
          {notification?.error?.response?.data?.message && (
            <div className={`${colors.details} mt-2 text-sm p-2 rounded`}>
              <div>
                {notification?.error?.response?.data?.message}
                {notification?.error?.response?.data?.details &&
                  notification?.error?.response?.data?.details !==
                    notification?.error?.response?.data?.message &&
                  !showMore && (
                    <span className="text-xs">
                      {' '}
                      (
                      <button
                        ref={showmoreRef}
                        aria-expanded={showMore}
                        aria-controls={detailsId}
                        onClick={() => setShowMore(!showMore)}
                        className="hover:underline cursor-pointer focus:outline-2 focus:outline-offset-2 focus:outline-inherit focus:rounded-md"
                      >
                        {t('common.show.more')} ...
                      </button>
                      )
                    </span>
                  )}
              </div>
              {showMore &&
                notification?.error?.response?.data?.details &&
                notification?.error?.response?.data?.details !==
                  notification?.error?.response?.data?.message && (
                  <>
                    <div
                      id={detailsId}
                      role="region"
                      aria-label={t('common.errorDetails')}
                      className="mt-2 text-xs whitespace-pre-wrap font-mono"
                    >
                      {notification?.error?.response?.data?.details}
                    </div>
                    {notification?.error?.response?.data?.details && showMore && (
                      <span className="text-xs">
                        {' '}
                        (
                        <button
                          aria-expanded={showMore}
                          aria-controls={detailsId}
                          onClick={() => setShowMore(!showMore)}
                          className="hover:underline cursor-pointer focus:outline-2 focus:outline-offset-2 focus:outline-inherit focus:rounded-md"
                        >
                          {t('common.show.less')}
                        </button>
                        )
                      </span>
                    )}
                  </>
                )}
            </div>
          )}
        </div>
      </div>
      {hasTimer && (
        <div
          className="flex items-center justify-center px-4 pb-2 gap-2"
          role="group"
          aria-label={t('actions.timerControls')}
        >
          <div className="text-sm tabular-nums w-1/2 text-end" role="timer" aria-live="polite">
            {Math.ceil(remainingTime / 1000)}s
          </div>
          <div className="relative w-1/2 leading-none">
            <button
              ref={playRef}
              aria-label={isPaused ? t('actions.resumeTimer') : t('actions.pauseTimer')}
              onClick={(e) => {
                e.stopPropagation();
                if (isPaused) {
                  setIsPaused(false);
                  resumeNotification(notification.id);
                } else {
                  setIsPaused(true);
                  pauseNotification(notification.id);
                }
              }}
              className="size-6 relative cursor-pointer rounded-full focus:outline-2 focus:outline-offset-2 focus:outline-inherit focus:rounded-full"
            >
              <div className="relative">
                <Icon
                  icon={isPaused ? 'play_arrow' : 'pause'}
                  fill
                  size={4}
                  className="p-1 box-content"
                />
                <div
                  aria-hidden
                  className={`size-6 absolute inset-0 border-3 border-inherit opacity-30 rounded-full`}
                ></div>
                <div
                  aria-hidden
                  className="size-6 absolute inset-0 border-3 border-inherit rounded-full -scale-x-100"
                  style={{
                    mask: `conic-gradient(transparent ${100 - remainingPercentage}%, black 0)`,
                    WebkitMask: `conic-gradient(transparent ${100 - remainingPercentage}%, black 0)`,
                  }}
                ></div>
              </div>
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
