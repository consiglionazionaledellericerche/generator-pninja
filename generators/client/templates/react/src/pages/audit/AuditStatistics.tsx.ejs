import { useEffect, useState, useCallback } from 'react';
import { Link } from 'react-router-dom';
import { useTranslation } from 'react-i18next';
import {
  ArrowTrendingUpIcon,
  CalendarDateRangeIcon,
  ChartBarIcon,
  ChartPieIcon,
  CubeIcon,
  UsersIcon,
} from '@heroicons/react/24/solid';
import {
  BarChart,
  Bar,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
  PieChart,
  Pie,
  Cell,
} from 'recharts';
import axiosInstance from '../../shared/axiosInstance';
import { useNotifications } from '../../contexts/NotificationContext';
import { SimpleLoader } from '../../components/SimpleLoader';

interface TooltipPayload {
  name: string;
  value: number;
  color: string;
  payload: {
    period: string;
    total: number;
  };
}

interface CustomTooltipProps {
  active?: boolean;
  payload?: TooltipPayload[] | undefined;
}
interface AuditStatistics {
  total: number;
  by_event: Array<{ event: string; total: number }>;
  by_model: Array<{ auditable_type: string; total: number }>;
  by_user: Array<{ user_id: string; total: number }>;
}

interface TimelineData {
  period: string;
  total: number;
  created: number;
  updated: number;
  deleted: number;
  restored: number;
}

interface TimelineResponse {
  data: TimelineData[];
  granularity: string;
  interval_days: number;
}

type Granularity = 'minute' | 'hour' | 'day' | 'month' | 'year';

const COLORS = {
  created: '#10b981',
  updated: '#3b82f6',
  deleted: '#ef4444',
  restored: '#a855f7',
};

export default function AuditStatistics() {
  const { t, i18n } = useTranslation();
  const { addNotification } = useNotifications();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState<AuditStatistics | null>(null);
  const [timeline, setTimeline] = useState<TimelineData[]>([]);
  const [granularity, setGranularity] = useState<Granularity>('day');
  const [intervalDays, setIntervalDays] = useState(0);
  const [dateFrom, setDateFrom] = useState(() => {
    const date = new Date();
    date.setDate(date.getDate() - 30);
    return date.toISOString().split('T')[0];
  });
  const [dateTo, setDateTo] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });

  const fillMissingPeriods = useCallback(
    (data: TimelineData[], dateFrom: string, dateTo: string, gran: Granularity): TimelineData[] => {
      if (data.length === 0) return [];

      const filled: TimelineData[] = [];
      const dataMap = new Map(data.map((item) => [item.period, item]));

      const [yearFrom, monthFrom, dayFrom] = dateFrom.split('-').map(Number);
      const [yearTo, monthTo, dayTo] = dateTo.split('-').map(Number);

      const start = new Date(yearFrom, monthFrom - 1, dayFrom, 0, 0, 0);
      const end = new Date(yearTo, monthTo - 1, dayTo, 23, 59, 59);

      const current = new Date(start);

      while (current <= end) {
        let periodKey: string;

        switch (gran) {
          case 'minute':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')} ${String(current.getHours()).padStart(2, '0')}:${String(current.getMinutes()).padStart(2, '0')}`;
            current.setMinutes(current.getMinutes() + 1);
            break;
          case 'hour':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')} ${String(current.getHours()).padStart(2, '0')}:00`;
            current.setHours(current.getHours() + 1);
            break;
          case 'day':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
            current.setDate(current.getDate() + 1);
            break;
          case 'month':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
            current.setMonth(current.getMonth() + 1);
            break;
          case 'year':
            periodKey = `${current.getFullYear()}`;
            current.setFullYear(current.getFullYear() + 1);
            break;
          default:
            periodKey = '';
        }

        const existingData = dataMap.get(periodKey);

        filled.push(
          existingData || {
            period: periodKey,
            total: 0,
            created: 0,
            updated: 0,
            deleted: 0,
            restored: 0,
          }
        );

        if (filled.length > 1000) {
          console.warn('Too many periods, stopping at 1000');
          break;
        }
      }

      return filled;
    },
    []
  );

  const loadData = useCallback(() => {
    setLoading(true);

    Promise.all([
      axiosInstance.get(`/api/audits/statistics?date_from=${dateFrom}&date_to=${dateTo}`),
      axiosInstance.get(`/api/audits/timeline?date_from=${dateFrom}&date_to=${dateTo}`),
    ])
      .then(([statsResponse, timelineResponse]) => {
        setStats(statsResponse.data);

        const timelineData: TimelineResponse = timelineResponse.data;
        const gran = timelineData.granularity as Granularity;

        const filledTimeline = fillMissingPeriods(timelineData.data, dateFrom, dateTo, gran);

        setTimeline(filledTimeline);
        setGranularity(gran);
        setIntervalDays(timelineData.interval_days);

        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        addNotification({
          type: 'error',
          message: error.message,
        });
      });
  }, [dateFrom, dateTo, fillMissingPeriods, addNotification]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const formatModelName = (fullName: string) => {
    const parts = fullName.split('\\');
    return parts[parts.length - 1];
  };

  const formatPeriodLabel = (periodString: string, gran: Granularity) => {
    const period = String(periodString);

    switch (gran) {
      case 'minute': {
        const minuteParts = period.split(' ');
        return minuteParts.length > 1 ? minuteParts[1] : period;
      }
      case 'hour': {
        const hourParts = period.split(' ');
        return hourParts.length > 1 ? hourParts[1].substring(0, 5) : period;
      }
      case 'day':
        try {
          const dayDate = new Date(period + 'T00:00:00');
          return dayDate.toLocaleDateString(i18n.language, {
            month: 'short',
            day: 'numeric',
          });
        } catch {
          return period;
        }
      case 'month':
        try {
          const monthParts = period.split('-');
          if (monthParts.length === 2) {
            const [year, month] = monthParts;
            const monthDate = new Date(parseInt(year), parseInt(month) - 1, 1);
            return monthDate.toLocaleDateString(i18n.language, {
              month: 'short',
              year: 'numeric',
            });
          }
          return period;
        } catch {
          return period;
        }
      case 'year':
        return period;
      default:
        return period;
    }
  };

  const getGranularityLabel = (gran: Granularity) => {
    const labels: Record<Granularity, string> = {
      minute: t('audit:granularity.minutes'),
      hour: t('audit:granularity.hours'),
      day: t('audit:granularity.days'),
      month: t('audit:granularity.months'),
      year: t('audit:granularity.years'),
    };
    return labels[gran];
  };

  const CustomTooltip = ({ active, payload }: CustomTooltipProps) => {
    if (active && payload && payload.length) {
      return (
        <div className="bg-white dark:bg-slate-800 p-3 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700">
          <p className="font-semibold mb-2">{payload[0].payload.period}</p>
          {payload.map((entry, index) => (
            <p key={index} className="text-sm" style={{ color: entry.color }}>
              {entry.name}: {entry.value}
            </p>
          ))}
          <p className="text-sm font-semibold mt-2 pt-2 border-t border-gray-200 dark:border-gray-700">
            {t('audit:total')}: {payload[0].payload.total}
          </p>
        </div>
      );
    }
    return null;
  };

  if (loading) {
    return <SimpleLoader />;
  }

  if (!stats) {
    return (
      <div className="text-center py-12">
        <p className="text-xl text-gray-600 dark:text-gray-400">
          {t('audit:noStatisticsAvailable')}
        </p>
      </div>
    );
  }

  // Prepara dati per PieChart eventi
  const eventChartData = stats.by_event.map((item) => ({
    name: t(`audit:events.${item.event}`),
    value: item.total,
    color: COLORS[item.event as keyof typeof COLORS] || '#6b7280',
  }));

  return (
    <>
      {/* Date Range Filter */}
      <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4 mb-6">
        <div className="flex flex-col md:flex-row items-start md:items-center gap-4">
          <CalendarDateRangeIcon className="text-gray-500 h-16" />
          <div className="flex flex-wrap items-center gap-4 flex-1">
            <div>
              <label className="block text-sm font-medium mb-1">{t('audit:dateFrom')}</label>
              <input
                type="date"
                value={dateFrom}
                onChange={(e) => setDateFrom(e.target.value)}
                className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600"
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">{t('audit:dateTo')}</label>
              <input
                type="date"
                value={dateTo}
                onChange={(e) => setDateTo(e.target.value)}
                className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600"
              />
            </div>
            <button onClick={loadData} className="secondary-button mt-6">
              {t('audit:refresh')}
            </button>
          </div>
          <div className="text-sm text-gray-600 dark:text-gray-400">
            {intervalDays} {intervalDays === 1 ? t('audit:day') : t('audit:days')}
          </div>
        </div>
      </div>

      {/* Total Card */}
      <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-6 mb-6">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-blue-100 text-sm font-medium">{t('audit:totalChanges')}</p>
            <p className="text-4xl font-bold mt-2">{stats.total.toLocaleString()}</p>
            <p className="text-blue-100 text-sm mt-2">
              {new Date(dateFrom + 'T00:00:00').toLocaleDateString(i18n.language)} -{' '}
              {new Date(dateTo + 'T00:00:00').toLocaleDateString(i18n.language)}
            </p>
          </div>
          <ChartBarIcon className="h-16 text-blue-200" />
        </div>
      </div>

      {/* Timeline Chart */}
      <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6 mb-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <ArrowTrendingUpIcon className="h-5" />
            {t('audit:activityTimeline')}
          </h2>
          <span className="text-sm px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full">
            {t('audit:groupedBy')}: {getGranularityLabel(granularity)}
          </span>
        </div>

        {timeline.length === 0 ? (
          <p className="text-sm text-gray-500 text-center py-8">{t('audit:noDataForPeriod')}</p>
        ) : (
          <ResponsiveContainer width="100%" height={400}>
            <BarChart data={timeline}>
              <CartesianGrid
                strokeDasharray="3 3"
                className="stroke-gray-200 dark:stroke-gray-700"
              />
              <XAxis
                dataKey="period"
                tickFormatter={(value) => formatPeriodLabel(value, granularity)}
                className="text-xs"
                angle={timeline.length > 20 ? -45 : 0}
                textAnchor={timeline.length > 20 ? 'end' : 'middle'}
                height={timeline.length > 20 ? 80 : 30}
              />
              <YAxis className="text-xs" />
              <Tooltip content={<CustomTooltip />} />
              <Legend wrapperStyle={{ paddingTop: '20px' }} iconType="rect" />
              <Bar
                dataKey="created"
                stackId="a"
                fill={COLORS.created}
                name={t('audit:events.created')}
                radius={[0, 0, 0, 0]}
              />
              <Bar
                dataKey="updated"
                stackId="a"
                fill={COLORS.updated}
                name={t('audit:events.updated')}
                radius={[0, 0, 0, 0]}
              />
              <Bar
                dataKey="deleted"
                stackId="a"
                fill={COLORS.deleted}
                name={t('audit:events.deleted')}
                radius={[0, 0, 0, 0]}
              />
              <Bar
                dataKey="restored"
                stackId="a"
                fill={COLORS.restored}
                name={t('audit:events.restored')}
                radius={[4, 4, 0, 0]}
              />
            </BarChart>
          </ResponsiveContainer>
        )}
      </div>

      {/* Stats grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* By Event - PieChart */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <ChartPieIcon className="h-5" />
            {t('audit:byEventType')}
          </h2>
          {stats.by_event.length === 0 ? (
            <p className="text-sm text-gray-500 text-center py-4">{t('audit:noData')}</p>
          ) : (
            <ResponsiveContainer width="100%" height={250}>
              <PieChart>
                <Pie
                  data={eventChartData}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({ name, percent }) => `${name} ${((percent ?? 0) * 100).toFixed(0)}%`}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="value"
                >
                  {eventChartData.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={entry.color} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          )}
        </div>

        {/* By Model - Horizontal Bar */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <CubeIcon className="h-5" />
            {t('audit:byModel')}
          </h2>
          {stats.by_model.length === 0 ? (
            <p className="text-sm text-gray-500 text-center py-4">{t('audit:noData')}</p>
          ) : (
            <div className="space-y-3">
              {stats.by_model.slice(0, 8).map((item) => {
                const maxCount = Math.max(...stats.by_model.map((m) => m.total));
                const percentage = (item.total / maxCount) * 100;
                return (
                  <div key={item.auditable_type}>
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-sm font-medium truncate" title={item.auditable_type}>
                        {formatModelName(item.auditable_type)}
                      </span>
                      <span className="text-sm font-medium">{item.total}</span>
                    </div>
                    <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                      <div
                        className="bg-green-500 h-2 rounded-full transition-all"
                        style={{ width: `${percentage}%` }}
                      ></div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>

        {/* By User - Horizontal Bar */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <UsersIcon className="h-5" />
            {t('audit:topUsers')}
          </h2>
          {stats.by_user.length === 0 ? (
            <p className="text-sm text-gray-500 text-center py-4">{t('audit:noData')}</p>
          ) : (
            <div className="space-y-3">
              {stats.by_user.map((item, index) => {
                const maxCount = Math.max(...stats.by_user.map((u) => u.total));
                const percentage = (item.total / maxCount) * 100;
                return (
                  <div key={item.user_id}>
                    <div className="flex items-center justify-between mb-1">
                      <div className="flex items-center gap-2">
                        <span className="text-xs font-bold text-gray-500">#{index + 1}</span>
                        <span className="text-sm font-medium truncate">
                          <Link to={`/audits/user/${item.user_id}`} className="text-link">
                            {item.user_id}
                          </Link>
                        </span>
                      </div>
                      <span className="text-sm font-medium">{item.total}</span>
                    </div>
                    <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                      <div
                        className="bg-purple-500 h-2 rounded-full transition-all"
                        style={{ width: `${percentage}%` }}
                      ></div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>
    </>
  );
}
