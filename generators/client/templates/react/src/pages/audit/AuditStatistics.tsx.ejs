// AuditStatistics.tsx
import { useEffect, useState, useCallback } from 'react';
import { useTranslation } from 'react-i18next';
import { BarChart3, Calendar, FileText, Users, TrendingUp } from 'lucide-react';
import axiosInstance from '../../shared/axiosInstance';
import { useNotifications } from '../../contexts/NotificationContext';
import { SimpleLoader } from '../../components/SimpleLoader';

interface AuditStatistics {
  total: number;
  by_event: Array<{ event: string; total: number }>;
  by_model: Array<{ auditable_type: string; total: number }>;
  by_user: Array<{ user_id: string; total: number }>;
}

interface TimelineData {
  period: string;
  total: number;
  created: number;
  updated: number;
  deleted: number;
  restored: number;
}

interface TimelineResponse {
  data: TimelineData[];
  granularity: string;
  interval_days: number;
}

type Granularity = 'minute' | 'hour' | 'day' | 'month' | 'year';

export default function AuditStatistics() {
  const { t, i18n } = useTranslation();
  const { addNotification } = useNotifications();
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState<AuditStatistics | null>(null);
  const [timeline, setTimeline] = useState<TimelineData[]>([]);
  const [granularity, setGranularity] = useState<Granularity>('day');
  const [intervalDays, setIntervalDays] = useState(0);
  const [dateFrom, setDateFrom] = useState(() => {
    const date = new Date();
    date.setDate(date.getDate() - 30);
    return date.toISOString().split('T')[0];
  });
  const [dateTo, setDateTo] = useState(() => {
    return new Date().toISOString().split('T')[0];
  });

  const fillMissingPeriods = useCallback(
    (data: TimelineData[], dateFrom: string, dateTo: string, gran: Granularity): TimelineData[] => {
      if (data.length === 0) return [];

      const filled: TimelineData[] = [];
      const dataMap = new Map(data.map((item) => [item.period, item]));

      // Parse date in LOCAL timezone
      const [yearFrom, monthFrom, dayFrom] = dateFrom.split('-').map(Number);
      const [yearTo, monthTo, dayTo] = dateTo.split('-').map(Number);

      const start = new Date(yearFrom, monthFrom - 1, dayFrom, 0, 0, 0);
      const end = new Date(yearTo, monthTo - 1, dayTo, 23, 59, 59);

      let current = new Date(start);

      while (current <= end) {
        let periodKey: string;

        switch (gran) {
          case 'minute':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')} ${String(current.getHours()).padStart(2, '0')}:${String(current.getMinutes()).padStart(2, '0')}`;
            current.setMinutes(current.getMinutes() + 1);
            break;
          case 'hour':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')} ${String(current.getHours()).padStart(2, '0')}:00`;
            current.setHours(current.getHours() + 1);
            break;
          case 'day':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
            current.setDate(current.getDate() + 1);
            break;
          case 'month':
            periodKey = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}`;
            current.setMonth(current.getMonth() + 1);
            break;
          case 'year':
            periodKey = `${current.getFullYear()}`;
            current.setFullYear(current.getFullYear() + 1);
            break;
          default:
            periodKey = '';
        }

        const existingData = dataMap.get(periodKey);

        filled.push(
          existingData || {
            period: periodKey,
            total: 0,
            created: 0,
            updated: 0,
            deleted: 0,
            restored: 0,
          }
        );

        // Safety: evita loop infiniti
        if (filled.length > 1000) {
          console.warn('Too many periods, stopping at 1000');
          break;
        }
      }

      return filled;
    },
    []
  );

  const loadData = useCallback(() => {
    setLoading(true);

    Promise.all([
      axiosInstance.get(`/api/audits/statistics?date_from=${dateFrom}&date_to=${dateTo}`),
      axiosInstance.get(`/api/audits/timeline?date_from=${dateFrom}&date_to=${dateTo}`),
    ])
      .then(([statsResponse, timelineResponse]) => {
        setStats(statsResponse.data);

        const timelineData: TimelineResponse = timelineResponse.data;
        const gran = timelineData.granularity as Granularity;

        // Riempi i periodi mancanti
        const filledTimeline = fillMissingPeriods(timelineData.data, dateFrom, dateTo, gran);

        setTimeline(filledTimeline);
        setGranularity(gran);
        setIntervalDays(timelineData.interval_days);

        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        addNotification({
          type: 'error',
          message: error.message,
        });
      });
  }, [dateFrom, dateTo, fillMissingPeriods, addNotification]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  const getEventBadgeClass = (event: string) => {
    const classes = {
      created: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300',
      updated: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300',
      deleted: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
      restored: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300',
    };
    return classes[event as keyof typeof classes] || 'bg-gray-100 text-gray-800';
  };

  const formatModelName = (fullName: string) => {
    const parts = fullName.split('\\');
    return parts[parts.length - 1];
  };

  const formatPeriodLabel = (periodString: string, gran: Granularity) => {
    // Converti sempre a stringa per sicurezza
    const period = String(periodString);

    switch (gran) {
      case 'minute':
        // "2025-12-15 10:30" -> "10:30"
        const minuteParts = period.split(' ');
        return minuteParts.length > 1 ? minuteParts[1] : period;
      case 'hour':
        // "2025-12-15 10:00" -> "10:00"
        const hourParts = period.split(' ');
        return hourParts.length > 1 ? hourParts[1].substring(0, 5) : period;
      case 'day':
        // "2025-12-15" -> "15 Dec"
        try {
          const dayDate = new Date(period + 'T00:00:00');
          return dayDate.toLocaleDateString(i18n.language, {
            month: 'short',
            day: 'numeric',
          });
        } catch {
          return period;
        }
      case 'month':
        // "2025-12" -> "Dec 2025"
        try {
          const monthParts = period.split('-');
          if (monthParts.length === 2) {
            const [year, month] = monthParts;
            const monthDate = new Date(parseInt(year), parseInt(month) - 1, 1);
            return monthDate.toLocaleDateString(i18n.language, {
              month: 'short',
              year: 'numeric',
            });
          }
          return period;
        } catch {
          return period;
        }
      case 'year':
        // "2025" -> "2025"
        return period;
      default:
        return period;
    }
  };

  const getGranularityLabel = (gran: Granularity) => {
    const labels: Record<Granularity, string> = {
      minute: t('Minutes'),
      hour: t('Hours'),
      day: t('Days'),
      month: t('Months'),
      year: t('Years'),
    };
    return labels[gran];
  };

  if (loading) {
    return <SimpleLoader />;
  }

  if (!stats) {
    return (
      <div className="text-center py-12">
        <p className="text-xl text-gray-600 dark:text-gray-400">{t('No statistics available')}</p>
      </div>
    );
  }

  const maxEventCount = Math.max(...stats.by_event.map((e) => e.total), 1);
  const maxModelCount = Math.max(...stats.by_model.map((m) => m.total), 1);
  const maxUserCount = Math.max(...stats.by_user.map((u) => u.total), 1);
  const maxTimelineTotal = Math.max(...timeline.map((t) => t.total), 1);

  return (
    <>
      <div className="mb-6">
        <h1 className="text-2xl font-bold mb-4">{t('Audit Statistics')}</h1>

        {/* Date Range Filter */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-4 mb-6">
          <div className="flex flex-col md:flex-row items-start md:items-center gap-4">
            <Calendar className="text-gray-500" size={20} />
            <div className="flex flex-wrap items-center gap-4 flex-1">
              <div>
                <label className="block text-sm font-medium mb-1">{t('From')}</label>
                <input
                  type="date"
                  value={dateFrom}
                  onChange={(e) => setDateFrom(e.target.value)}
                  className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600"
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">{t('To')}</label>
                <input
                  type="date"
                  value={dateTo}
                  onChange={(e) => setDateTo(e.target.value)}
                  className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600"
                />
              </div>
              <button onClick={loadData} className="primary-button mt-6">
                {t('Refresh')}
              </button>
            </div>
            <div className="text-sm text-gray-600 dark:text-gray-400">
              {intervalDays} {intervalDays === 1 ? t('day') : t('days')}
            </div>
          </div>
        </div>
      </div>

      {/* Total Card */}
      <div className="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-lg shadow-lg p-6 mb-6">
        <div className="flex items-center justify-between">
          <div>
            <p className="text-blue-100 text-sm font-medium">{t('Total Changes')}</p>
            <p className="text-4xl font-bold mt-2">{stats.total.toLocaleString()}</p>
            <p className="text-blue-100 text-sm mt-2">
              {new Date(dateFrom + 'T00:00:00').toLocaleDateString(i18n.language)} -{' '}
              {new Date(dateTo + 'T00:00:00').toLocaleDateString(i18n.language)}
            </p>
          </div>
          <BarChart3 size={64} className="text-blue-200" />
        </div>
      </div>

      {/* Timeline Chart */}
      <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6 mb-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-lg font-semibold flex items-center gap-2">
            <TrendingUp size={20} />
            {t('Activity Timeline')}
          </h2>
          <span className="text-sm px-3 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded-full">
            {t('Grouped by')}: {getGranularityLabel(granularity)}
          </span>
        </div>

        {timeline.length === 0 ? (
          <p className="text-sm text-gray-500 text-center py-8">{t('No data for this period')}</p>
        ) : (
          <div className="overflow-x-auto">
            <div className="flex items-end gap-2 min-w-max h-64 px-4">
              {timeline.map((item) => (
                <div key={item.period} className="flex flex-col items-center gap-2 alla w-1/24">
                  {/* Total count - SOPRA */}
                  <div className="text-xs font-semibold text-gray-700 dark:text-gray-300 h-4">
                    {item.total > 0 ? item.total : ''}
                  </div>

                  {/* Stacked bars */}
                  <div className="flex flex-col-reverse gap-1 w-full items-center flex-1">
                    {item.total === 0 ? (
                      <div
                        className="w-full bg-gray-200 dark:bg-gray-700 rounded"
                        style={{ height: '4px' }}
                        title={t('No activity')}
                      ></div>
                    ) : (
                      <>
                        {item.created > 0 && (
                          <div
                            className="w-full bg-green-500 hover:bg-green-600 transition-colors cursor-help"
                            style={{ height: `${(item.created / maxTimelineTotal) * 200}px` }}
                            title={`${t('created')}: ${item.created}`}
                          ></div>
                        )}
                        {item.updated > 0 && (
                          <div
                            className="w-full bg-blue-500 hover:bg-blue-600 transition-colors cursor-help"
                            style={{ height: `${(item.updated / maxTimelineTotal) * 200}px` }}
                            title={`${t('updated')}: ${item.updated}`}
                          ></div>
                        )}
                        {item.deleted > 0 && (
                          <div
                            className="w-full bg-red-500 hover:bg-red-600 transition-colors cursor-help"
                            style={{ height: `${(item.deleted / maxTimelineTotal) * 200}px` }}
                            title={`${t('deleted')}: ${item.deleted}`}
                          ></div>
                        )}
                        {item.restored > 0 && (
                          <div
                            className="w-full bg-purple-500 hover:bg-purple-600 transition-colors cursor-help"
                            style={{ height: `${(item.restored / maxTimelineTotal) * 200}px` }}
                            title={`${t('restored')}: ${item.restored}`}
                          ></div>
                        )}
                      </>
                    )}
                  </div>

                  {/* Period label */}
                  <div className="text-xs text-gray-500 dark:text-gray-400 text-center whitespace-nowrap">
                    {formatPeriodLabel(item.period, granularity)}
                  </div>
                </div>
              ))}
            </div>

            {/* Legend */}
            <div className="flex justify-center gap-4 mt-6 pt-4 border-t dark:border-slate-700">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-500 rounded"></div>
                <span className="text-sm">{t('created')}</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-blue-500 rounded"></div>
                <span className="text-sm">{t('updated')}</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-500 rounded"></div>
                <span className="text-sm">{t('deleted')}</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-purple-500 rounded"></div>
                <span className="text-sm">{t('restored')}</span>
              </div>
            </div>
          </div>
        )}
      </div>

      {/* Stats grid */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* By Event */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <FileText size={20} />
            {t('By Event Type')}
          </h2>
          <div className="space-y-3">
            {stats.by_event.map((item) => (
              <div key={item.event}>
                <div className="flex items-center justify-between mb-1">
                  <span
                    className={`px-2 py-1 text-xs font-semibold rounded ${getEventBadgeClass(item.event)}`}
                  >
                    {t(item.event)}
                  </span>
                  <span className="text-sm font-medium">{item.total}</span>
                </div>
                <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div
                    className="bg-blue-500 h-2 rounded-full transition-all"
                    style={{ width: `${(item.total / maxEventCount) * 100}%` }}
                  ></div>
                </div>
              </div>
            ))}
            {stats.by_event.length === 0 && (
              <p className="text-sm text-gray-500 text-center py-4">{t('No data')}</p>
            )}
          </div>
        </div>

        {/* By Model */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <FileText size={20} />
            {t('By Model')}
          </h2>
          <div className="space-y-3">
            {stats.by_model.slice(0, 10).map((item) => (
              <div key={item.auditable_type}>
                <div className="flex items-center justify-between mb-1">
                  <span className="text-sm font-medium truncate" title={item.auditable_type}>
                    {formatModelName(item.auditable_type)}
                  </span>
                  <span className="text-sm font-medium">{item.total}</span>
                </div>
                <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div
                    className="bg-green-500 h-2 rounded-full transition-all"
                    style={{ width: `${(item.total / maxModelCount) * 100}%` }}
                  ></div>
                </div>
              </div>
            ))}
            {stats.by_model.length === 0 && (
              <p className="text-sm text-gray-500 text-center py-4">{t('No data')}</p>
            )}
          </div>
        </div>

        {/* By User */}
        <div className="bg-white dark:bg-slate-800 rounded-lg shadow p-6">
          <h2 className="text-lg font-semibold mb-4 flex items-center gap-2">
            <Users size={20} />
            {t('Top Users')}
          </h2>
          <div className="space-y-3">
            {stats.by_user.map((item, index) => (
              <div key={item.user_id}>
                <div className="flex items-center justify-between mb-1">
                  <div className="flex items-center gap-2">
                    <span className="text-xs font-bold text-gray-500">#{index + 1}</span>
                    <span className="text-sm font-medium truncate">{item.user_id}</span>
                  </div>
                  <span className="text-sm font-medium">{item.total}</span>
                </div>
                <div className="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                  <div
                    className="bg-purple-500 h-2 rounded-full transition-all"
                    style={{ width: `${(item.total / maxUserCount) * 100}%` }}
                  ></div>
                </div>
              </div>
            ))}
            {stats.by_user.length === 0 && (
              <p className="text-sm text-gray-500 text-center py-4">{t('No data')}</p>
            )}
          </div>
        </div>
      </div>
    </>
  );
}
