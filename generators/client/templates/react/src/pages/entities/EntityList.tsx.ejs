import { Link } from 'react-router-dom';
import { Fragment, useCallback, useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import {
  ChevronDown,
  ChevronLeft,
  ChevronRight,
  ChevronUp,
  ChevronsUpDown,
  Plus,
} from 'lucide-react';
import { useApi } from '../../hooks/useApi';
import { ApiResponsePage, SortConfig } from '../../types/api-response.types';
<% if(durationColumns.length) {-%>
import { DurationFieldViewer } from '../../components/formElements/DurationField';
<% } -%>
import { TableSkeletonLoader } from '../../components/TableSkeletonLoader';
import { I<%= entity.name %> } from '../../shared/model/<%= to.slug(entity.name)%>.model';
import { useNotifications } from '../../contexts/NotificationContext';
import useAutoShortcuts from '../../hooks/useAutoShortcuts';
import { detect } from 'detect-browser';
const isMac = detect()?.os?.toLowerCase().includes('mac');

type SortableField = 'id'<%for(column of columns) { %><% if (!fileColumns.includes(column)) { %> | '<%=column%>'<% } %><% } %>;

export default function <%= entity.name %>List() {
  const { t, i18n } = useTranslation();
  const { addNotification } = useNotifications();
  const { fetch } = useApi();
  const [loading, setLoading] = useState(false);
    const [sortConfig, setSortConfig] = useState<SortConfig<SortableField>>({
    field: 'id',
    direction: 'asc',
  });
  const [currentPage, setCurrentPage] = useState(1);
  const [page, setPage] = useState<ApiResponsePage<I<%= entity.name %>> | null>(null);
  useAutoShortcuts();
  const sortableColumns: SortableField[] = [
    'id',
<%for(column of columns) { -%>
<%  if (!fileColumns.includes(column)) { -%>
    '<%=column%>',
<%  }-%>
<%}-%>
  ];

  const loadRecords = useCallback(() => {
    setLoading(true);
    fetch(`/api/<%=to.slug(pluralize(entity.name))%>?page=${currentPage}&sort_by=${sortConfig.field}&sort_direction=${sortConfig.direction}`)
      .then((response) => response.json())
      .then((page: ApiResponsePage<I<%= entity.name %>>) => {
        setPage(page);
        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        addNotification({
          type: 'error',
          message: error.message,
          duration: 5000,
        });
      });
  }, [fetch, addNotification, sortConfig, currentPage]);

  const handleSort = (field: SortableField) => {
    setSortConfig((currentConfig) => ({
      field,
      direction:
        currentConfig.field === field && currentConfig.direction === 'asc' ? 'desc' : 'asc',
    }));
    setCurrentPage(1);
  };

  const renderSortHeader = (field: SortableField, label: string) => {
    const isSorted = sortConfig.field === field;
    return (
      <th
        scope="col"
        className={`${sortableColumns.includes(field) ? 'cursor-pointer select-none' : ''} ${field === 'id' ? 'w-0' : ''}`}
        onClick={() => sortableColumns.includes(field) && handleSort(field)}
      >
        <div className="flex items-center gap-1">
          <div>{label}</div>
          {isSorted &&
            (sortConfig.direction === 'asc' ?
              <ChevronDown className="shrink-0 pointer-events-none size-5 text-gray-500 sm:size-4" />
            :
              <ChevronUp className="shrink-0 pointer-events-none size-5 text-gray-500 sm:size-4" />
            )}
          {!isSorted && <ChevronsUpDown className="shrink-0 pointer-events-none size-5 text-gray-500 sm:size-4" />}
        </div>
      </th>
    );
  };

  useEffect(() => loadRecords(), [loadRecords]);

  useEffect(() => {
    document.title = t('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>');
  }, [i18n.language, t]);

  return <div className="m-4">
    <h1 className="text-2xl mb-4">{t('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>')}</h1>
    <div className="flex justify-end gap-4 mb-4">
      <Link
        to="/entities/<%=to.slug(pluralize(entity.name))%>/new"
        className="primary-button"
        data-shortcut="ctrl+enter"
      >
        <Plus size={16} />
        {t('actions.crud.create')} {t('entities.<%-to.snake(entity.name)%>.<%- entity.name%>')}
        <kbd className="kdb-shortcut">{isMac ? '⌘' : 'Ctrl'}</kbd>
        <kbd className="kdb-shortcut">↵</kbd>
      </Link>
    </div>
    <Fragment>
      <TableSkeletonLoader loading={loading} rows={10} cols={<%=columns.length - fileColumns.length + relatedEntities.length%>} />
    </Fragment>
    {!loading && page?.data && page?.data.length > 0 && (
    <div className="relative overflow-x-auto">
      <table className="data-table">
        <thead>
          <tr>
            {renderSortHeader('id', t('entities.<%-to.snake(entity.name)%>.id'))}
<%          for(column of columns) { -%>
<%            if (!fileColumns.includes(column)) { -%>
            {renderSortHeader('<%-column%>', t('entities.<%-to.snake(entity.name)%>.<%-column%>'))}
<%            } -%>
<%          } -%>
<%          for(r of relatedEntities) { -%>
            <th scope="col">{t('entities.<%-to.snake(entity.name)%>.<%-r.field%>')}</th>
<%          } -%>
            <th scope="col">{t('actions.crud.actions')}</th>
          </tr>
        </thead>
        <tbody>
          {page?.data.map((row, key) => (
            <tr key={key} className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
              <td className="w-0">
                <Link className="text-link" to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`}>
                  {row.id}
                </Link>
              </td>
<%            for(column of columns) { -%>
<%              if (!fileColumns.includes(column)) { -%>
              <td>
<%                if (!durationColumns.includes(column)) { -%>
                {row.<%- column %>?.toString()}
<%                } else {-%>
                <DurationFieldViewer duration={row.<%- column %>} format="iso"/>
<%                }-%>
              </td>
<%              } -%>
<%            } -%>
<%            for(r of relatedEntities) { -%>
              <td>
<%            if(r.isArray) { -%>
                {row?.<%-r.field%>?.map((row, index) => (<Fragment key={index}>{index !== 0 ? ', ': ''}<Link className="text-link" to={`/entities/<%=to.slug(pluralize(r.related))%>/view/${row?.id}`}>{row?.<%-to.snake(r.labelField)%>}</Link></Fragment>))}
<%              } else { -%>
                {row?.<%-r.field%>?.id && <Link className="text-link" to={`/entities/<%=to.slug(pluralize(r.related))%>/view/${row?.<%-r.field%>?.id}`}>{row?.<%-r.field%>?.<%-to.snake(r.labelField)%>}</Link>}
<%              } -%>
              </td>
<%            } -%>
              <td className="text-nowrap w-0 uppercase">
                <div className="flex space-x-2">
                  <Link to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`} className="text-link">{t('actions.crud.view')}</Link>
                  <Link to={`/entities/<%=to.slug(pluralize(entity.name))%>/edit/${row.id}`} className="text-link">{t('actions.crud.edit')}</Link>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      {page.links && page.links.length > 0 && (
        <div className="text-center">
          <nav
            aria-label="Pagination"
            className="isolate inline-flex -space-x-px rounded-md shadow-xs mb-5"
          >
            {page.links &&
              page.links.length > 0 &&
              page.links.map((link, index, array) => (
                <button
                  key={index}
                  type="button"
                  className={`
                    ${link.url ? 'cursor-pointer hover:bg-gray-50 hover:dark:bg-gray-800' : 'cursor-not-allowed bg-gray-200 dark:bg-gray-700'}
                    ${link.active ? 'font-bold text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-800' : 'text-gray-500 dark:text-gray-400'}
                    focus:outline-none focus-visible:ring-4 focus:z-99 relative inline-flex items-center
                    ${index === 0 ? 'rounded-l-md' : ''}
                    ${index === array.length - 1 ? 'rounded-r-md' : ''}
                    px-4 py-2 inset-ring inset-ring-gray-200 dark:inset-ring-gray-700
                    `}
                  onClick={() =>
                    link.url &&
                    setCurrentPage(
                      link.url.split('page=')[1].split('&')[0] as unknown as number
                    )
                  }
                >
                  {index === 0 && <ChevronLeft size={16} />}
                  {index === array.length - 1 && <ChevronRight size={16} />}
                  {index > 0 && index < array.length - 1 && link.label}
                </button>
              ))}
          </nav>
        </div>
      )}
    </div>
    )}
  </div>;
}
