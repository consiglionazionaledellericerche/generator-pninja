import { Link } from 'react-router-dom';
import { Fragment, useCallback, useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { useAuthenticatedFetch } from '../../hooks/useAuthenticatedFetch';
import { TableSkeletonLoader } from '../../components/TableSkeletonLoader';
import { I<%= entity.name %> } from '../../shared/model/<%= to.slug(entity.name)%>.model';
import { useNotifications } from '../../contexts/NotificationContext';

export default function <%= entity.name %>() {
  const { t, i18n } = useTranslation();
  const { addNotification } = useNotifications();
  const authenticatedFetch = useAuthenticatedFetch();
  const [<%=to.camel(pluralize(entity.name))%>, <%=to.camel(pluralize(`set${entity.name}`))%>] = useState<I<%= entity.name %>[]>([]);
  const [loading, setLoading] = useState(false);

  const loadRecords = useCallback(() => {
    setLoading(true);
    authenticatedFetch(`/api/<%=to.slug(pluralize(entity.name))%>`)
      .then((response) => response.json())
      .then((data: I<%= entity.name %>[]) => {
        <%=to.camel(pluralize(`set${entity.name}`))%>(data);
        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        alert(error.message);
      });
  }, [authenticatedFetch]);

  const delete<%= entity.name %> = (id: number | undefined) => {
    if (!id) return;
    authenticatedFetch(`/api/<%=to.slug(pluralize(entity.name))%>/${id}`, {
      method: 'DELETE',
    })
      .then(() => {
        loadRecords();
        addNotification({
            type: 'success',
            message: `<%= entity.name %> ID ${id} deleted successfully`,
            duration: 3000
        });
      })
      .catch((error) => {
        addNotification({
            type: 'error',
            message: error.message || `Error deleting <%= entity.name %> ID ${id}`,
            duration: 5000
        });
      });
  };

  useEffect(() => loadRecords(), [loadRecords]);

  useEffect(() => {
    document.title = t('entities.<%-to.snake(entity.name)%>.<%- to.capital(pluralize(entity.name))%>');
  }, [i18n.language, t]);

  return <div className="m-4">
    <h1 className="text-2xl mb-4">{t('entities.<%-to.snake(entity.name)%>.<%- to.capital(pluralize(entity.name))%>')}</h1>
    <Fragment>
      <TableSkeletonLoader loading={loading} rows={10} cols={<%=columns.length + foreignIds.length%>} />
    </Fragment>
    {!loading && <%=to.camel(pluralize(entity.name))%> && <%=to.camel(pluralize(entity.name))%>.length > 0 && (
    <div className="relative overflow-x-auto">
      <table className="data-table">
        <thead>
          <tr>
            <th scope="col" className="w-0">{t('entities.<%-to.snake(entity.name)%>.id')}</th>
<%          for(column of columns) { -%>
            <th scope="col">{t('entities.<%-to.snake(entity.name)%>.<%-column%>')}</th>
<%          } -%>
<%          for(r of relatedEntities) { -%>
            <th scope="col">{t('entities.<%-to.snake(entity.name)%>.<%-r.field%>')}</th>
<%          } -%>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {<%=to.camel(pluralize(entity.name))%>.map((row, key) => (
            <tr key={key} className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
              <td className="w-0">
                <Link className="text-link" to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`}>
                  {row.id}
                </Link>
              </td>
<%            for(column of columns) { -%>
              <td>
                {row.<%= column%>}
              </td>
<%            } -%>
<%            for(r of relatedEntities) { -%>
              <td>
<%            if(r.isArray) { -%>
                {row?.<%-r.field%>?.map((row, index) => (<Fragment key={index}>{index !== 0 ? ', ': ''}<Link className="text-link" to={`/entities/<%=to.slug(pluralize(r.related))%>/view/${row?.id}`}>{row?.id}</Link></Fragment>))}
<%              } else { -%>
                {row?.<%-r.field%>?.id && <Link className="text-link" to={`/entities/<%=to.slug(pluralize(r.related))%>/view/${row?.<%-r.field%>?.id}`}>{row?.<%-r.field%>?.id}</Link>}
<%              } -%>
              </td>
<%            } -%>
              <td className="text-nowrap w-0 uppercase">
                <div className="flex space-x-2">
                  <Link to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`} className="text-link">View</Link>
                  <Link to={`/entities/<%=to.slug(pluralize(entity.name))%>/edit/${row.id}`} className="text-link">Edit</Link>
                  <button
                    onClick={() => delete<%= entity.name %>(row.id)}
                    className="text-link cursor-pointer uppercase"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    )}
  </div>;
}
