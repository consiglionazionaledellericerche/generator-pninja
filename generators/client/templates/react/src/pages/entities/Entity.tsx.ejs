import { Link } from 'react-router-dom';
import { Fragment, useCallback, useEffect, useState, useMemo } from 'react';
import { useTranslation } from 'react-i18next';
import { ArrowDown01, ArrowDownAZ, ArrowDownUp, ArrowUp10, ArrowUpZA, Plus } from 'lucide-react';
import { useAuthenticatedFetch } from '../../hooks/useAuthenticatedFetch';
import { TableSkeletonLoader } from '../../components/TableSkeletonLoader';
import { I<%= entity.name %> } from '../../shared/model/<%= to.slug(entity.name)%>.model';
import { useNotifications } from '../../contexts/NotificationContext';

type SortDirection = 'asc' | 'desc';
type SortableField = keyof Pick<
  I<%= entity.name %>,
  | 'id'
<%for(column of columns) { -%>
  | '<%=column%>'
<%}-%>
>;

interface SortConfig {
  field: SortableField;
  direction: SortDirection;
}

export default function <%= entity.name %>() {
  const { t, i18n } = useTranslation();
  const { addNotification } = useNotifications();
  const authenticatedFetch = useAuthenticatedFetch();
  const [<%=to.camel(pluralize(entity.name))%>, <%=to.camel(pluralize(`set${entity.name}`))%>] = useState<I<%= entity.name %>[]>([]);
  const [loading, setLoading] = useState(false);
  const [sortConfig, setSortConfig] = useState<SortConfig>({ field: 'id', direction: 'asc' });

  const sortableColumns: SortableField[] = [
    'id',
<%for(column of columns) { -%>
    '<%=column%>',
<%}-%>
  ];

  const loadRecords = useCallback(() => {
    setLoading(true);
    authenticatedFetch(`/api/<%=to.slug(pluralize(entity.name))%>`)
      .then((response) => response.json())
      .then((data: I<%= entity.name %>[]) => {
        <%=to.camel(pluralize(`set${entity.name}`))%>(data);
        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        addNotification({
          type: 'error',
          message: error.message,
          duration: 5000,
        });
      });
  }, [authenticatedFetch, addNotification]);

  const handleSort = (field: SortableField) => {
    setSortConfig((currentConfig) => ({
      field,
      direction:
        currentConfig.field === field && currentConfig.direction === 'asc' ? 'desc' : 'asc',
    }));
  };

  const <%=to.camel(pluralize(`sorted${entity.name}`))%> = useMemo(() => {
    const sorted = [...<%=to.camel(pluralize(entity.name))%>];
    sorted.sort((a, b) => {
      const aValue = a[sortConfig.field];
      const bValue = b[sortConfig.field];

      if (aValue === null || aValue === undefined) return sortConfig.direction === 'asc' ? 1 : -1;
      if (bValue === null || bValue === undefined) return sortConfig.direction === 'asc' ? -1 : 1;

      if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
      if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
      return 0;
    });
    return sorted;
  }, [<%=to.camel(pluralize(entity.name))%>, sortConfig]);

  const renderSortHeader = (field: SortableField, label: string) => {
    const isNum = [<%- numericColums.join(', ') %>].includes(field);
    const isSorted = sortConfig.field === field;
    return (
      <th
        scope="col"
        className={`${sortableColumns.includes(field) ? 'cursor-pointer select-none' : ''} ${field === 'id' ? 'w-0' : ''}`}
        onClick={() => sortableColumns.includes(field) && handleSort(field)}
      >
        <div className="flex items-center gap-1">
          {label}
          {isSorted &&
            (sortConfig.direction === 'asc' ? (
              isNum ? <ArrowDown01 size={16} /> : <ArrowDownAZ size={16} />
            ) : (
              isNum ? <ArrowUp10 size={16} /> : <ArrowUpZA size={16} />
            ))}
          {!isSorted && <ArrowDownUp size={16} />}
        </div>
      </th>
    );
  };

  const delete<%= entity.name %> = (id: number | undefined) => {
    if (!id) return;
    authenticatedFetch(`/api/<%=to.slug(pluralize(entity.name))%>/${id}`, {
      method: 'DELETE',
    })
      .then(() => {
        loadRecords();
        addNotification({
            type: 'success',
            message: `<%= entity.name %> ID ${id} deleted successfully`,
            duration: 3000
        });
      })
      .catch((error) => {
        addNotification({
            type: 'error',
            message: error.message || `Error deleting <%= entity.name %> ID ${id}`,
            details: error?.details,
            duration: 5000
        });
      });
  };

  useEffect(() => loadRecords(), [loadRecords]);

  useEffect(() => {
    document.title = t('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>');
  }, [i18n.language, t]);

  return <div className="m-4">
    <h1 className="text-2xl mb-4">{t('entities.<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>')}</h1>
    <div className="flex justify-end gap-4 mb-4">
      <Link
        to="/entities/<%=to.slug(pluralize(entity.name))%>/new"
        className="inline-flex items-center gap-1 cursor-pointer rounded-md border border-transparent bg-indigo-600 py-2 px-4 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 disabled:opacity-50"
      >
        <Plus size={16} />
        {t('actions.crud.create')} {t('entities.<%-to.snake(entity.name)%>.<%- entity.name%>')}
      </Link>
    </div>
    <Fragment>
      <TableSkeletonLoader loading={loading} rows={10} cols={<%=columns.length + relatedEntities.length%>} />
    </Fragment>
    {!loading && <%=to.camel(pluralize(entity.name))%> && <%=to.camel(pluralize(entity.name))%>.length > 0 && (
    <div className="relative overflow-x-auto">
      <table className="data-table">
        <thead>
          <tr>
            {renderSortHeader('id', t('entities.<%-to.snake(entity.name)%>.id'), true)}
<%          for(column of columns) { -%>
            {renderSortHeader('<%-column%>', t('entities.<%-to.snake(entity.name)%>.<%-column%>'))}
<%          } -%>
<%          for(r of relatedEntities) { -%>
            <th scope="col">{t('entities.<%-to.snake(entity.name)%>.<%-r.field%>')}</th>
<%          } -%>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {<%=to.camel(pluralize(`sorted${entity.name}`))%>.map((row, key) => (
            <tr key={key} className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
              <td className="w-0">
                <Link className="text-link" to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`}>
                  {row.id}
                </Link>
              </td>
<%            for(column of columns) { -%>
              <td>
                {row.<%= column%>}
              </td>
<%            } -%>
<%            for(r of relatedEntities) { -%>
              <td>
<%            if(r.isArray) { -%>
                {row?.<%-r.field%>?.map((row, index) => (<Fragment key={index}>{index !== 0 ? ', ': ''}<Link className="text-link" to={`/entities/<%=to.slug(pluralize(r.related))%>/view/${row?.id}`}>{row?.<%-to.snake(r.labelField)%>}</Link></Fragment>))}
<%              } else { -%>
                {row?.<%-r.field%>?.id && <Link className="text-link" to={`/entities/<%=to.slug(pluralize(r.related))%>/view/${row?.<%-r.field%>?.id}`}>{row?.<%-r.field%>?.<%-to.snake(r.labelField)%>}</Link>}
<%              } -%>
              </td>
<%            } -%>
              <td className="text-nowrap w-0 uppercase">
                <div className="flex space-x-2">
                  <Link to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`} className="text-link">View</Link>
                  <Link to={`/entities/<%=to.slug(pluralize(entity.name))%>/edit/${row.id}`} className="text-link">Edit</Link>
                  <button
                    onClick={() => delete<%= entity.name %>(row.id)}
                    className="text-link cursor-pointer uppercase"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    )}
  </div>;
}
