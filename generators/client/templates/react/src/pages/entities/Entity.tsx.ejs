import { Link } from 'react-router-dom';
import { useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { useAuthenticatedFetch } from '../../hooks/useAuthenticatedFetch';
import { TableSkeletonLoader } from '../../components/TableSkeletonLoader';
import { I<%= entity.name %> } from '../../shared/model/<%= to.slug(entity.name)%>.model';

export default function <%= entity.name %>() {
  const { t } = useTranslation();
  const authenticatedFetch = useAuthenticatedFetch();
  const [<%=to.camel(pluralize(entity.name))%>, <%=to.camel(pluralize(`set${entity.name}`))%>] = useState<I<%= entity.name %>[]>([]);
  const [loading, setLoading] = useState(false);

  const handleSearch = () => {
    setLoading(true);
    authenticatedFetch(`/api/<%=to.slug(pluralize(entity.name))%>`)
      .then((response) => response.json())
      .then((data: I<%= entity.name %>[]) => {
        <%=to.camel(pluralize(`set${entity.name}`))%>(data);
        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        // alert('ERR');
      });
  };

  useEffect(() => {
    handleSearch();
  }, []);

  return <div className="m-4">
    <h1 className="text-2xl mb-4">{t('entities.<%-to.snake(entity.name)%>.<%- to.capital(pluralize(entity.name))%>')}</h1>
    <TableSkeletonLoader loading={loading} rows={10} cols={<%=columns.length + foreignIds.length%>} />
    {!loading && <%=to.camel(pluralize(entity.name))%> && <%=to.camel(pluralize(entity.name))%>.length > 0 && (
      <div className="relative overflow-x-auto">
      <table className="data-table">
        <thead>
          <tr>
            <th scope="col" className="w-0">
              {t('entities.<%-to.snake(entity.name)%>.id')}
            </th>
            <% for(column of columns) {%>
            <th scope="col">
              {t('entities.<%-to.snake(entity.name)%>.<%-column%>')}
            </th>
            <%}%>
            <% if (false) for(f of foreignIds) {%>
            <th scope="col">
              {t('entities.<%-to.snake(entity.name)%>.<%-f.foreignId%>')}
            </th>
            <%}%>
          </tr>
        </thead>
        <tbody>
          {<%=to.camel(pluralize(entity.name))%>.map((row, key) => (
            <tr key={key} className="odd:bg-white odd:dark:bg-gray-900 even:bg-gray-50 even:dark:bg-gray-800 border-b dark:border-gray-700 border-gray-200">
              <td className="w-0">
                <Link className="text-link" to={`/entities/<%=to.slug(pluralize(entity.name))%>/view/${row.id}`}>
                  {row.id}
                </Link>
              </td>
              <% for(column of columns) {%>
              <td>{row.<%= column%>}</td>
              <%}%>
              <% if (false) for(f of foreignIds) {%>
              <td>
                <Link className="text-link" to={`/entities/<%=to.slug(pluralize(f.related))%>/view/${row.<%= f.foreignId%>}`}>
                  {row.<%= f.foreignId%>}
                </Link>
              </td>
              <%}%>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
    )}
  </div>;
}
