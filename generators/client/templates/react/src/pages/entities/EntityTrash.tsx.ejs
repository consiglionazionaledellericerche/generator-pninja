import { Link } from 'react-router-dom';
import { Fragment, useCallback, useEffect, useState } from 'react';
import { useTranslation } from 'react-i18next';
import { ChevronDown, ChevronUp, ChevronsUpDown, History, RotateCcw, Trash2 } from 'lucide-react';
import axiosInstance from '../../shared/axiosInstance';
import { AxiosError } from 'axios';
import { ApiResponsePage, SortConfig } from '../../types/api-response.types';
import { ApiResponsePagination } from '../../components/ApiResponsePagination';
<% if(durationColumns.length) {-%>
import { DurationFieldViewer } from '../../components/formElements/DurationField';
<% } -%>
import { TableSkeletonLoader } from '../../components/TableSkeletonLoader';
import { I<%= entity.name %> } from '../../shared/model/<%= to.slug(entity.name)%>.model';
import { ErrorResponseData, useNotifications } from '../../contexts/NotificationContext';
import useAutoShortcuts from '../../hooks/useAutoShortcuts';
import { Can } from '../../components/Can';
import ConfirmButton from '../../components/ConfirmButton';

type SortableField = 'id'<%for(column of columns) { %><% if (!fileColumns.includes(column)) { %> | '<%=column%>'<% } %><% } %>;

export default function <%= entity.name %>Trash() {
  const { t, i18n } = useTranslation();
  const { addNotification } = useNotifications();
  const [loading, setLoading] = useState(false);
  const [sortConfig, setSortConfig] = useState<SortConfig<SortableField>>({
    field: 'id',
    direction: 'asc',
  });
  const [currentPage, setCurrentPage] = useState(1);
  const [page, setPage] = useState<ApiResponsePage<I<%= entity.name %>> | null>(null);
  useAutoShortcuts();
  const sortableColumns: SortableField[] = [
    'id',
<%for(column of columns) { -%>
<%  if (!fileColumns.includes(column)) { -%>
    '<%=column%>',
<%  }-%>
<%}-%>
  ];

  const loadRecords = useCallback(() => {
    setLoading(true);
    axiosInstance
      .get(
        `/api/trashed-<%=to.slug(pluralize(entity.name))%>?page=${currentPage}&sort_by=${sortConfig.field}&sort_direction=${sortConfig.direction}`
      )
      .then((response) => response?.data)
      .then((page: ApiResponsePage<I<%= entity.name %>>) => {
        setPage(page);
        setLoading(false);
      })
      .catch((error) => {
        console.error('ERR:', error);
        setLoading(false);
        addNotification({
          type: 'error',
          message: error.message,
        });
      });
  }, [addNotification, sortConfig, currentPage]);

  const handleSort = (field: SortableField) => {
    setSortConfig((currentConfig) => ({
      field,
      direction:
        currentConfig.field === field && currentConfig.direction === 'asc' ? 'desc' : 'asc',
    }));
    setCurrentPage(1);
  };

  const handleRestore = async (id: number | undefined | null) => {
    if (!id) return;
    axiosInstance
      .post(`/api/trashed-<%=to.slug(pluralize(entity.name))%>/`, { id })
      .then(() => {
        addNotification({
          type: 'success',
          message: t(`actions.crud.successfullyRestored`, { id }),
        });
        loadRecords();
      })
      .catch((error: AxiosError<ErrorResponseData>) => {
        addNotification({
          type: 'error',
          message: `${t('errors.entities.delete')} ${t('entities:pilot.Pilot')} ID ${id}`,
          error,
        });
      });
  };

  const handleForceDelete = async (id: number | undefined | null) => {
    if (!id) return;
    axiosInstance
      .delete(`/api/trashed-<%=to.slug(pluralize(entity.name))%>/${id}`)
      .then(() => {
        addNotification({
          type: 'success',
          message: t(`actions.crud.successfullyForceDeleted`, { id }),
        });
        loadRecords();
      })
      .catch((error: AxiosError<ErrorResponseData>) => {
        addNotification({
          type: 'error',
          message: `${t('errors.entities.forceDelete')} ${t('entities:pilot.Pilot')} ID ${id}`,
          error,
        });
      });
  };

  interface SortHeaderProps extends React.HTMLAttributes<HTMLTableCellElement> {
    field: string;
    label: string;
    className?: string;
  }

  const SortHeader: React.FC<SortHeaderProps> = ({ field, label, className, ...props }) => {
    const isSorted = sortConfig.field === field;
    const isSortable = sortableColumns.includes(field as SortableField);
    if (!isSortable) {
      return (
        <th scope="col" className={className ? className : ''} {...props}>
          {label}
        </th>
      );
    }
    return (
      <th
        scope="col"
        className={`${isSortable ? 'cursor-pointer select-none py-0! px-0!' : ''}${className ? ' ' + className : ''}`}
        onClick={() => isSortable && handleSort(field as SortableField)}
        {...props}
      >
        <button
          className="cursor-pointer flex items-center gap-4 w-full ps-6 py-3 text-nowrap truncate"
          aria-label={t(
            `common.sortBy.${isSorted && sortConfig.direction === 'asc' ? 'descending' : 'ascending'}`,
            {
              field: label,
            }
          )}
        >
          <div className="grow text-left">{label}</div>
          {isSorted &&
            (sortConfig.direction === 'asc' ? (
              <ChevronDown
                aria-hidden
                className="shrink-0 pointer-events-none size-5 text-slate-600 dark:text-slate-400 sm:size-4"
              />
            ) : (
              <ChevronUp
                aria-hidden
                className="shrink-0 pointer-events-none size-5 text-slate-600 dark:text-slate-400 sm:size-4"
              />
            ))}
          {!isSorted && (
            <ChevronsUpDown
              aria-hidden
              className="shrink-0 pointer-events-none size-5 text-slate-600 dark:text-slate-400 sm:size-4"
            />
          )}
        </button>
      </th>
    );
  };

  useEffect(() => loadRecords(), [loadRecords]);

  useEffect(() => {
    document.title = t('entities:<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>');
  }, [i18n.language, t]);

  return (
    <>
      <h1 className="text-2xl mb-4">{t('entities:<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>')}</h1>
      <Fragment>
        <TableSkeletonLoader loading={loading} rows={10} cols={<%=columns.length - fileColumns.length + relatedEntities.length%>} />
      </Fragment>
      {!loading && page?.data && page?.data.length === 0 && (
        <p className="mb-4 text-2xl">{t('messages.noData')}</p>
      )}
      {!loading && page?.data && page?.data.length > 0 && (
        <>
          <div className="relative overflow-x-auto mb-4">
            <table className="data-table">
              <caption className="w-full text-left mb-2 text-sm font-normal">
                {t('pagination.summary', {
                  entity: t('entities:<%-to.snake(entity.name)%>.<%- pluralize(entity.name)%>'),
                  from: page?.from,
                  to: page?.to,
                  total: page?.total,
                })}
              </caption>
              <thead>
                <tr>
                  <SortHeader className="w-0" field="id" label={t('entities:<%-to.snake(entity.name)%>.id')} />
<%  for(column of columns) { -%>
                  <SortHeader field="<%-column%>" label={t('entities:<%-to.snake(entity.name)%>.<%-column%>')} />
<%  } -%>
                  <th scope="col">{t('actions.crud.actions')}</th>
                </tr>
              </thead>
              <tbody>
                {page?.data.map((row, key) => (
                  <tr key={key}>
                    <td className="w-0">
                      <Link className="text-link" to={`/audits/entity/${encodeURIComponent(`App\\Models\\<%= entity.name %>`)}/${row?.id}`}>
                        {row.id}
                      </Link>
                    </td>
<%                  for(column of columns) { -%>
<%                    if (!fileColumns.includes(column)) { -%>
                    <td><% if (!durationColumns.includes(column)) { %>{row.<%- column %>?.toString()}<% } else { %><DurationFieldViewer duration={row.<%- column %>} format="iso"/><% } %></td>
<%                    } else { -%>
                    <td>
                      <a
                        href={`/api/<%=to.slug(pluralize(entity.name))%>/${row.id}/<%- column %>/${row.<%- column %>_name}`}
                        className="text-link"
                        target="_blank"
                        rel="noopener noreferrer"
                      >
                        {row.<%- column %>_name?.toString()}
                      </a>
                    </td>
<%                    } -%>
<%                  } -%>
                    <td className="text-nowrap w-0 uppercase">
                      <div className="flex space-x-2">
                        <Can resource="Audit" action="read">
                          <Link
                            to={`/audits/entity/${encodeURIComponent(`App\\Models\\<%= entity.name %>`)}/${row?.id}`}
                            className="secondary-button"
                          >
                            <History size={16} />
                            {t('audit:allChanges')}
                          </Link>
                        </Can>
                        <Can resource="Trashed<%= entity.name %>" action="create">
                          <ConfirmButton
                            onConfirm={() => handleRestore(row?.id)}
                            className="primary-button"
                            pendingClassName="primary-button"
                            label={
                              <span className="flex items-center gap-2 uppercase">
                                <RotateCcw className="size-4" aria-hidden />
                                {t('actions.crud.restore')}
                              </span>
                            }
                            pendingLabel={
                              <span className="flex items-center gap-2 uppercase">
                                <RotateCcw className="size-4" aria-hidden />
                                {t('actions.crud.confirmRestore')}
                              </span>
                            }
                          />
                        </Can>
                        <Can resource="Trashed<%= entity.name %>" action="delete">
                          <ConfirmButton
                            onConfirm={() => handleForceDelete(row?.id)}
                            className="danger-button"
                            pendingClassName="danger-button"
                            label={
                              <span className="flex items-center gap-2 uppercase">
                                <Trash2 className="size-4" aria-hidden />
                                {t('actions.crud.deletePermanently')}
                              </span>
                            }
                            pendingLabel={
                              <span className="flex items-center gap-2 uppercase">
                                <Trash2 className="size-4" aria-hidden />
                                {t('actions.crud.confirmDeletePermanently')}
                              </span>
                            }
                          />
                        </Can>
                      </div>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
          <ApiResponsePagination pageLinks={page.links || []} onSelectPage={setCurrentPage} />
        </>
      )}
    </>
  );
}
