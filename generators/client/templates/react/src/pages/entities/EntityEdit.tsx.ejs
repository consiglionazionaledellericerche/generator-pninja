import { useParams, useNavigate } from 'react-router-dom';
import { useState, useEffect } from 'react';
import { useTranslation } from 'react-i18next';
import { AxiosError } from 'axios';
import axiosInstance from '../../shared/axiosInstance';
import { ErrorResponseData, useNotifications } from '../../contexts/NotificationContext';
import { SimpleLoader } from '../../components/SimpleLoader';
import { I<%= entity.name %> } from '../../shared/model/<%= to.slug(entity.name)%>.model';
import { <%= entity.name %>Form } from '../../components/entities/<%= entity.name %>Form';

interface <%= entity.name %>ViewParams extends Record<string, string | undefined> {
  id: string;
}

export default function <%= entity.name %>Edit() {
  const { t, i18n } = useTranslation();
  const { id } = useParams<<%= entity.name %>ViewParams>();
  const navigate = useNavigate();
  const { addNotification } = useNotifications();
  const [<%=to.camel(entity.name)%>, <%=to.camel(`set${entity.name}`)%>] = useState<I<%= entity.name %>>({} as I<%= entity.name %>);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (id) {
      setLoading(true);
      axiosInstance
        .get(`/api/<%=to.slug(pluralize(entity.name))%>/${id}`)
        .then((response) => response?.data)
        .then((data: I<%= entity.name %>) => {
          set<%= entity.name %>(data);
        })
        .catch((error: AxiosError<ErrorResponseData>) => {
          addNotification({
            type: 'error',
            message: `${t('errors.entities.read')} ${t('entities:<%-to.snake(entity.name)%>.<%= entity.name %>')}${id ? ` ID ${id}` : ''}`,
            error,
          });
          navigate('/entities/<%=to.slug(pluralize(entity.name))%>');
        })
        .finally(() => {
          setLoading(false);
        });
    }
  }, [id, addNotification, navigate, t]);

  const handleSubmit = (data: I<%= entity.name %>) => {
    (id ? axiosInstance.put(`/api/<%=to.slug(pluralize(entity.name))%>/${id}`, data) : axiosInstance.post('/api/<%=to.slug(pluralize(entity.name))%>', data))
      .then((response) => response?.data)
      .then((data: I<%= entity.name %>) => {
        addNotification({
          type: 'success',
          message: t(`actions.crud.successfully${id ? 'Updated' : 'Created'}`, {
            id: id || data.id,
          }),
        });
        navigate('/entities/<%=to.slug(pluralize(entity.name))%>');
      })
      .catch((error: AxiosError<ErrorResponseData>) =>
        addNotification({
          type: 'error',
          message: `${t(id ? 'errors.entities.update' : 'errors.entities.create')} ${t('entities:<%-to.snake(entity.name)%>.<%= entity.name %>')}${id ? ` ID ${id}` : ''}`,
          error,
        })
      );
  };

  useEffect(() => {
    document.title = `${t(`actions.crud.${id ? 'update' : 'create'}`)} ${t('entities:<%-to.snake(entity.name)%>.<%= entity.name %>')}${id ? ` ID ${id}` : ''}`;
  }, [id, i18n.language, t]);

  return (
    <div className="max-w-5xl mx-auto">
      <h1 className="text-2xl my-8">
        {t(`actions.crud.${id ? 'update' : 'create'}`)} {t('entities:<%-to.snake(entity.name)%>.<%= entity.name %>')}
        {id ? ` ID ${id}` : ''}
      </h1>
      <SimpleLoader loading={loading} />
      {!loading && (
        <<%= entity.name %>Form
          <%-to.camel(entity.name)%>={<%-to.camel(entity.name)%>}
          onSubmit={handleSubmit}
          onCancel={() => navigate('/entities/<%=to.slug(pluralize(entity.name))%>')}
        />
      )}
    </div>
  );
}
