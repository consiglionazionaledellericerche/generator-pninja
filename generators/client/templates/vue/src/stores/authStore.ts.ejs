import { defineStore } from 'pinia'
import Keycloak from 'keycloak-js'
import keycloakService from '@/services/keycloak'

type User = {
  username: string | undefined
  token: string | undefined
  refToken: string | undefined
}

export type State = {
  authenticated: boolean
  user: User
}

export type Actions = {
  initOauth: (keycloak: Keycloak, clearData?: boolean) => void
  logout(): void
  refreshUserToken(): void
  clearUserData(): void
}

export const useAuthStore = defineStore({
  id: 'storeAuth',
  state: (): State => {
    return {
      authenticated: false,
      user: {
        username: undefined,
        token: undefined,
        refToken: undefined
      }
    }
  },
  persist: true,
  getters: {},
  actions: {
    // Initialize Keycloak OAuth
    async initOauth(keycloak: Keycloak, clearData = true) {
      if (clearData) {
        await this.clearUserData()
      }
      this.authenticated = keycloak.authenticated || false
      this.user.username = keycloak.idTokenParsed?.preferred_username
      this.user.token = keycloak.token
      this.user.refToken = keycloak.refreshToken
    },
    // Logout user
    async logout() {
      try {
        await keycloakService.CallLogout(import.meta.env.VITE_APP_URL)
        await this.clearUserData()
      } catch (error) {
        console.error(error)
      }
    },
    // Refresh user's token
    async refreshUserToken() {
      try {
        const keycloak: Keycloak | undefined = await keycloakService.CallTokenRefresh()
        if (keycloak) {
          this.initOauth(keycloak, false)
        }
      } catch (error) {
        console.error(error)
      }
    },
    // Clear user's store data
    clearUserData() {
      this.authenticated = false
      this.user = {
        username: undefined,
        token: undefined,
        refToken: undefined
      }
    }
  }
})
